<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç´«å¾®æ–—æ•° - å‘½è¿çš„å…¨æ¯å®‡å®™</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Lunar Calendar Library -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.min.js"></script>
    <!-- Marked for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* Base Reset & Fonts */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #050510; 
            color: #fff; 
            font-family: 'Noto Sans SC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }
        
        /* Canvas Layer */
        #canvas-container { 
            width: 100vw; 
            height: 100vh; 
            height: 100dvh; /* Dynamic viewport height for mobile */
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
            touch-action: none; /* Crucial for OrbitControls on mobile */
        }
        
        /* UI Overlay Layer */
        #ui-layer {
            position: absolute;
            z-index: 10;
            pointer-events: none; 
            width: 100%;
            height: 100%;
            height: 100dvh;
            padding: 0;
            overflow: hidden; 
        }

        /* Glassmorphism Panel Base */
        .panel {
            background: rgba(10, 15, 30, 0.75);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(100, 200, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 12px;
            pointer-events: auto; 
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        /* --- DESKTOP LAYOUT (Default) --- */
        /* Input Panel (Top Left) */
        .input-panel {
            position: absolute;
            top: 24px;
            left: 24px;
            width: 320px;
            border-left: 3px solid #219ebc;
            max-height: 90vh;
            overflow: hidden; 
            z-index: 20;
        }

        .input-panel.collapsed {
            max-height: 64px;
            background: rgba(10, 15, 30, 0.6);
        }
        
        .input-panel.collapsed .input-content {
            opacity: 0;
            pointer-events: none;
        }
        
        .input-content {
            padding: 24px;
            padding-top: 10px;
            overflow-y: auto;
            transition: opacity 0.3s ease;
            scrollbar-width: none;
            max-height: calc(90vh - 64px);
        }

        /* Info Panel (Right) */
        .info-panel {
            position: absolute;
            top: 24px;
            right: 24px;
            width: 380px; 
            max-width: 90vw;
            transform: translateX(120%); 
            border-right: 3px solid #ffb703;
            max-height: 85vh; 
            z-index: 20;
        }
        .info-panel.active {
            transform: translateX(0);
        }

        .info-panel.collapsed {
            max-height: 64px; 
            overflow: hidden;
            border-bottom: none;
        }
        
        /* Panel Headers */
        .panel-header {
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            min-height: 64px; 
        }
        .panel-header:active {
            background: rgba(255, 255, 255, 0.1);
        }
        .toggle-icon {
            transition: transform 0.3s ease;
            color: #94a3b8;
        }
        .input-panel.collapsed .toggle-icon,
        .info-panel.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .info-scroll {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            transition: opacity 0.3s ease;
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }

        /* Typography & Inputs */
        h1 { font-size: 1.4rem; color: #8ecae6; margin: 0; text-shadow: 0 0 15px rgba(33, 158, 188, 0.6); letter-spacing: 2px; }
        h2 { font-size: 1.4rem; color: #ffb703; margin: 0; text-shadow: 0 0 10px rgba(255, 183, 3, 0.4); }
        label { display: block; font-size: 0.75rem; color: #94a3b8; margin-top: 12px; text-transform: uppercase; letter-spacing: 1px; }
        
        input, select {
            width: 100%;
            background: rgba(0,0,0,0.4);
            border: 1px solid #334455;
            color: #e0f0ff;
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
            font-size: 16px; 
            transition: all 0.3s;
            appearance: none;
        }
        input:focus, select:focus {
            border-color: #38bdf8;
            outline: none;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
        }

        /* Buttons & Animations */
        .uiverse {
            --duration: 7s; --easing: linear; --c-color-1: rgba(56, 189, 248, 0.7); --c-color-2: #4361ee; --c-color-3: #c084fc; --c-color-4: rgba(34, 211, 238, 0.7);
            --c-shadow: rgba(56, 189, 248, 0.4); --c-shadow-inset-top: rgba(56, 189, 248, 0.6); --c-shadow-inset-bottom: rgba(67, 97, 238, 0.6);
            --c-radial-inner: #1e293b; --c-radial-outer: #0f172a; --c-color: #fff;
            -webkit-tap-highlight-color: transparent; -webkit-appearance: none; outline: none; position: relative; cursor: pointer; border: none; display: table; border-radius: 24px; padding: 0; margin-top: 25px; width: 100%; text-align: center; font-weight: 600; font-size: 16px; letter-spacing: 0.02em; line-height: 1.5; color: var(--c-color); background: radial-gradient(circle, var(--c-radial-inner), var(--c-radial-outer) 80%); box-shadow: 0 0 14px var(--c-shadow);
        }
        .uiverse:before { content: ""; pointer-events: none; position: absolute; z-index: 3; left: 0; top: 0; right: 0; bottom: 0; border-radius: 24px; box-shadow: inset 0 3px 12px var(--c-shadow-inset-top), inset 0 -3px 4px var(--c-shadow-inset-bottom); }
        .uiverse .wrapper { -webkit-mask-image: -webkit-radial-gradient(white, black); overflow: hidden; border-radius: 24px; min-width: 132px; padding: 12px 0; width: 100%; }
        .uiverse .wrapper span { display: inline-block; position: relative; z-index: 1; }
        .uiverse .wrapper .circle { position: absolute; left: 0; top: 0; width: 40px; height: 40px; border-radius: 50%; filter: blur(var(--blur, 8px)); background: var(--background, transparent); transform: translate(var(--x, 0), var(--y, 0)) translateZ(0); animation: var(--animation, none) var(--duration) var(--easing) infinite; }
        .uiverse .wrapper .circle.circle-1, .uiverse .wrapper .circle.circle-9, .uiverse .wrapper .circle.circle-10 { --background: var(--c-color-4); }
        .uiverse .wrapper .circle.circle-3, .uiverse .wrapper .circle.circle-4 { --background: var(--c-color-2); --blur: 14px; }
        .uiverse .wrapper .circle.circle-5, .uiverse .wrapper .circle.circle-6 { --background: var(--c-color-3); --blur: 16px; }
        .uiverse .wrapper .circle.circle-2, .uiverse .wrapper .circle.circle-7, .uiverse .wrapper .circle.circle-8, .uiverse .wrapper .circle.circle-11, .uiverse .wrapper .circle.circle-12 { --background: var(--c-color-1); --blur: 12px; }
        .uiverse .wrapper .circle.circle-1 { --x: 0; --y: -40px; --animation: circle-1; }
        .uiverse .wrapper .circle.circle-2 { --x: 92px; --y: 8px; --animation: circle-2; }
        .uiverse .wrapper .circle.circle-3 { --x: -12px; --y: -12px; --animation: circle-3; }
        .uiverse .wrapper .circle.circle-4 { --x: 80px; --y: -12px; --animation: circle-4; }
        .uiverse .wrapper .circle.circle-5 { --x: 12px; --y: -4px; --animation: circle-5; }
        .uiverse .wrapper .circle.circle-6 { --x: 56px; --y: 16px; --animation: circle-6; }
        .uiverse .wrapper .circle.circle-7 { --x: 8px; --y: 28px; --animation: circle-7; }
        .uiverse .wrapper .circle.circle-8 { --x: 28px; --y: -4px; --animation: circle-8; }
        .uiverse .wrapper .circle.circle-9 { --x: 20px; --y: -12px; --animation: circle-9; }
        .uiverse .wrapper .circle.circle-10 { --x: 64px; --y: 16px; --animation: circle-10; }
        .uiverse .wrapper .circle.circle-11 { --x: 4px; --y: 4px; --animation: circle-11; }
        .uiverse .wrapper .circle.circle-12 { --blur: 14px; --x: 52px; --y: 4px; --animation: circle-12; }
        @keyframes circle-1 { 33% { transform: translate(0px, 16px) translateZ(0); } 66% { transform: translate(12px, 64px) translateZ(0); } }
        @keyframes circle-2 { 33% { transform: translate(80px, -10px) translateZ(0); } 66% { transform: translate(72px, -48px) translateZ(0); } }
        @keyframes circle-3 { 33% { transform: translate(20px, 12px) translateZ(0); } 66% { transform: translate(12px, 4px) translateZ(0); } }
        @keyframes circle-4 { 33% { transform: translate(76px, -12px) translateZ(0); } 66% { transform: translate(112px, -8px) translateZ(0); } }
        @keyframes circle-5 { 33% { transform: translate(84px, 28px) translateZ(0); } 66% { transform: translate(40px, -32px) translateZ(0); } }
        @keyframes circle-6 { 33% { transform: translate(28px, -16px) translateZ(0); } 66% { transform: translate(76px, -56px) translateZ(0); } }
        @keyframes circle-7 { 33% { transform: translate(8px, 28px) translateZ(0); } 66% { transform: translate(20px, -60px) translateZ(0); } }
        @keyframes circle-8 { 33% { transform: translate(32px, -4px) translateZ(0); } 66% { transform: translate(56px, -20px) translateZ(0); } }
        @keyframes circle-9 { 33% { transform: translate(20px, -12px) translateZ(0); } 66% { transform: translate(80px, -8px) translateZ(0); } }
        @keyframes circle-10 { 33% { transform: translate(68px, 20px) translateZ(0); } 66% { transform: translate(100px, 28px) translateZ(0); } }
        @keyframes circle-11 { 33% { transform: translate(4px, 4px) translateZ(0); } 66% { transform: translate(68px, 20px) translateZ(0); } }
        @keyframes circle-12 { 33% { transform: translate(56px, 0px) translateZ(0); } 66% { transform: translate(60px, -32px) translateZ(0); } }

        /* AI Text Button */
        .ai-text-btn {
            margin-top: 20px; width: 100%; height: auto; background: transparent; padding: 10px 0; border: none; cursor: pointer;
            --border-right: 4px; --text-stroke-color: rgba(56, 189, 248, 0.5); --animation-color: #38bdf8; --fs-size: 1.1rem;
            letter-spacing: 2px; font-size: var(--fs-size); font-family: 'Noto Sans SC', sans-serif; position: relative; text-transform: uppercase;
            color: transparent; -webkit-text-stroke: 1px var(--text-stroke-color); display: flex; justify-content: center; align-items: center;
        }
        .ai-text-btn .actual-text { position: relative; color: transparent; -webkit-text-stroke: 1px var(--text-stroke-color); }
        .ai-text-btn .hover-text {
            position: absolute; box-sizing: border-box; content: attr(data-text); color: var(--animation-color);
            width: 0%; inset: 0; border-right: var(--border-right) solid var(--animation-color); overflow: hidden; transition: 0.5s;
            -webkit-text-stroke: 1px var(--animation-color); display: flex; justify-content: center; align-items: center; margin: auto;
        }
        .ai-text-btn:hover .hover-text { width: 100%; filter: drop-shadow(0 0 15px var(--animation-color)); }
        
        .ai-btn {
            background: linear-gradient(135deg, #7c3aed 0%, #4f46e5 100%); border: 1px solid rgba(139, 92, 246, 0.3); margin-top: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.3);
            border-radius: 8px; padding: 12px; color: white; font-size: 1rem;
        }
        
        /* Tags & Colors */
        .star-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; margin-bottom: 4px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.05); font-weight: bold; }
        .star-miao { color: #ffd700; border-color: #ffd700; background: rgba(255, 215, 0, 0.15); box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); } 
        .star-wang { color: #ffad33; border-color: #ffad33; background: rgba(255, 173, 51, 0.1); } 
        .star-de   { color: #4ade80; border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
        .star-li   { color: #60a5fa; border-color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
        .star-ping { color: #94a3b8; border-color: #94a3b8; background: rgba(148, 163, 184, 0.1); }
        .star-bu   { color: #94a3b8; border-color: #94a3b8; opacity: 0.7; } 
        .star-xian { color: #f87171; border-color: #f87171; opacity: 0.8; background: rgba(248, 113, 113, 0.1); }
        .sihua-lu { color: #4ade80; font-weight: bold; text-shadow: 0 0 5px rgba(74, 222, 128, 0.5); }
        .sihua-quan { color: #60a5fa; font-weight: bold; text-shadow: 0 0 5px rgba(96, 165, 250, 0.5); }
        .sihua-ke { color: #c084fc; font-weight: bold; text-shadow: 0 0 5px rgba(192, 132, 252, 0.5); }
        .sihua-ji { color: #f43f5e; font-weight: bold; text-shadow: 0 0 5px rgba(244, 63, 94, 0.5); }

        /* Loader */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #02040a; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .planets { position: relative; height: 100px; width: 100px; display: flex; justify-content: center; align-items: center; }
        #planetTrail1, #planetTrail2, #planetTrail3 { outline: solid rgb(101, 101, 101) 1px; border-radius: 50%; position: absolute; inset: 0; margin: auto; }
        #planetTrail1::after, #planetTrail2::after, #planetTrail3::after { content: ""; width: 10px; height: 10px; position: absolute; border-radius: 50%; top: -5px; left: 50%; transform: translateX(-50%); }
        #planetTrail1::after { background-color: rgb(213, 213, 120); }
        #planetTrail2::after { background-color: rgb(115, 174, 231); }
        #planetTrail3::after { background-color: rgb(180, 73, 49); }
        #planetTrail1 { width: 120px; height: 120px; animation: trails1 2s infinite; }
        #planetTrail2 { width: 170px; height: 170px; animation: trails2 2s infinite; }
        #planetTrail3 { width: 220px; height: 220px; animation: trails3 2s infinite; }
        @keyframes trails1 { 0% { transform: rotate(0deg); } 40% { transform: rotate(360deg); width: 120px; height: 120px; } 50% { width: 0px; height: 0px; } 90% { width: 0px; height: 0px; } 100% { width: 120px; height: 120px; } }
        @keyframes trails2 { 0% { transform: rotate(0deg); } 40% { transform: rotate(250deg); width: 170px; height: 170px; } 50% { width: 0px; height: 0px; } 90% { width: 0px; height: 0px; } 100% { width: 170px; height: 170px; } }
        @keyframes trails3 { 0% { transform: rotate(0deg); } 40% { transform: rotate(170deg); width: 220px; height: 220px; } 50% { width: 0px; height: 0px; } 90% { width: 0px; height: 0px; } 100% { width: 220px; height: 220px; } }
        #star { position: absolute; width: 50px; height: 50px; background-color: rgb(255, 170, 0); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: bouncingStar 2s infinite; }
        #starShadow { position: absolute; width: 50px; height: 20px; background-color: rgb(255, 170, 0); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, 100%); filter: blur(5px); opacity: 0.3; animation: shadowAnimation 2s infinite; }
        @keyframes bouncingStar { 0% { transform: translate(-50%, -50%); } 10% { transform: translate(-50%, -30%); } 20% { transform: translate(-50%, -50%); } 30% { transform: translate(-50%, -30%); } 40% { transform: translate(-50%, -50%); width: 50px; height: 50px; } 50% { width: 0px; height: 0px; } 90% { width: 0px; height: 0px; } 100% { width: 50px; height: 50px; } }
        @keyframes shadowAnimation { 0% { opacity: 0.1; } 10% { opacity: 0.4; } 20% { opacity: 0.1; } 30% { opacity: 0.4; } 40% { opacity: 0.1; } 50% { opacity: 0; } 90% { opacity: 0; } 100% { opacity: 0.1; } }
        #blackHole { position: absolute; width: 50px; height: 50px; background-color: rgb(0, 0, 0); outline: orange solid 5px; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); animation: bouncingBlackHole 2s infinite; }
        @keyframes bouncingBlackHole { 0% { height: 0px; width: 0px; } 40% { width: 0px; height: 0px; } 50% { width: 50px; height: 50px; } 90% { width: 50px; height: 50px; } 100% { width: 0px; height: 0px; } }
        #blackHoleDisk1 { position: absolute; width: 68px; height: 68px; clip-path: inset(50% 0 0 0); border: black 10px solid; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%) rotateX(70deg); animation: diskAn 2s infinite; }
        #blackHoleDisk2 { position: absolute; width: 70px; height: 70px; clip-path: inset(0 0 50% 0); border: rgb(245, 174, 8) 10px solid; border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%) rotateX(55deg); animation: diskAn 2s infinite; }
        @keyframes diskAn { 0% { height: 0px; width: 0px; border: orange 0px solid; } 40% { width: 0px; height: 0px; border: orange 0px solid; } 50% { width: 88px; height: 88px; border: orange 18px solid; } 90% { width: 88px; height: 88px; border: orange 18px solid; } 100% { width: 0px; height: 0px; border: orange 0px solid; } }
        #planet { position: absolute; width: 10px; height: 10px; background-color: rgb(255, 255, 255); border-radius: 50%; animation: planetAn 2s infinite; }
        @keyframes planetAn { 0% { opacity: 0; transform: translate(0px, 0px); z-index: 1; } 50% { opacity: 0; transform: translate(0px, 0px); z-index: 1; } 58% { opacity: 1; } 70% { opacity: 1; transform: translate(100px, 40px); z-index: 1; } 71% { z-index: 0; } 90% { z-index: 0; opacity: 1; transform: translate(-10px, 70px); } 100% { transform: translate(-10px, 70px); opacity: 0; } }

        /* Modal & Floating Common */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 60; display: none; justify-content: center; align-items: center; pointer-events: auto; }
        .ai-content { background: linear-gradient(145deg, #10141d, #1a1f2e); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 12px; border: 1px solid #7c3aed; padding: 30px; overflow-y: auto; position: relative; box-shadow: 0 0 50px rgba(124, 58, 237, 0.2); }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #94a3b8; transition: color 0.2s; }
        .close-modal:hover { color: #fff; }
        .markdown-body h3 { color: #a78bfa; margin-top: 1.2em; font-size: 1.1em; font-weight: bold; border-bottom: 1px dashed rgba(167, 139, 250, 0.3); padding-bottom: 5px; }
        .markdown-body p { line-height: 1.7; margin-bottom: 0.8em; color: #e2e8f0; }
        .markdown-body strong { color: #fbbf24; }

        /* AI Loading Spinner (xXJollyHAKERXx) */
        .spinner {
            background-image: linear-gradient(rgb(186, 66, 255) 35%,rgb(0, 225, 255));
            width: 100px;
            height: 100px;
            animation: spinning82341 1.7s linear infinite;
            text-align: center;
            border-radius: 50px;
            filter: blur(1px);
            box-shadow: 0px -5px 20px 0px rgb(186, 66, 255), 0px 5px 20px 0px rgb(0, 225, 255);
            /* Center the spinner1 inside */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .spinner1 {
            background-color: rgb(36, 36, 36);
            width: 100px;
            height: 100px;
            border-radius: 50px;
            filter: blur(10px);
        }

        @keyframes spinning82341 {
            to {
                transform: rotate(360deg);
            }
        }

        /* Floating Panels (Desktop default) */
        .floating-window { position: absolute; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); display: none; flex-direction: column; pointer-events: auto; z-index: 45; box-shadow: 0 20px 60px rgba(0,0,0,0.8); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .chat-window { bottom: 110px; right: 30px; width: 360px; height: 500px; border: 1px solid #334155; border-radius: 12px; }
        .chat-header { padding: 15px; background: linear-gradient(90deg, #1e293b, #0f172a); border-bottom: 1px solid #334155; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; font-size: 0.9rem; scrollbar-width: thin; scrollbar-color: #334155 transparent; }
        .chat-input-area { padding: 15px; border-top: 1px solid #334155; display: flex; gap: 8px; background: #1e293b; border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; }
        .chat-input { flex: 1; background: #0f172a; border: 1px solid #334155; padding: 10px; border-radius: 6px; color: white; font-size: 16px; }
        .msg { margin-bottom: 12px; padding: 10px 14px; border-radius: 10px; max-width: 85%; line-height: 1.5; }
        .msg-user { background: linear-gradient(135deg, #4361ee, #3a0ca3); align-self: flex-end; margin-left: auto; color: white; border-bottom-right-radius: 2px; }
        .msg-ai { background: #2a3b55; align-self: flex-start; color: #e2e8f0; border-bottom-left-radius: 2px; }

        .calendar-panel { bottom: 110px; right: 30px; width: 340px; max-height: calc(100vh - 140px); border: 1px solid rgba(255, 215, 0, 0.2); font-family: 'Noto Sans SC', sans-serif; overflow: hidden; }
        .cal-header { background: linear-gradient(to right, #2c1a00, #4a3500); padding: 20px; text-align: center; border-bottom: 2px solid #b8860b; position: relative; flex-shrink: 0; }
        .cal-header::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-top: 6px solid #b8860b; }
        .cal-date-big { font-size: 2.2rem; font-weight: bold; color: #fff; line-height: 1; margin-bottom: 5px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .cal-lunar { font-size: 1.2rem; color: #ffd700; letter-spacing: 4px; margin-bottom: 5px; }
        .cal-ganzhi { font-size: 0.85rem; color: #aaa; font-family: 'Noto Sans SC', sans-serif; opacity: 0.8; }
        .cal-body { padding: 20px; overflow-y: auto; flex: 1; min-height: 0; }
        .yiji-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .yiji-box { padding: 10px; border-radius: 8px; position: relative; }
        .yiji-box.yi { background: rgba(0, 100, 0, 0.2); border: 1px solid rgba(50, 205, 50, 0.3); }
        .yiji-box.ji { background: rgba(100, 0, 0, 0.2); border: 1px solid rgba(255, 69, 0, 0.3); }
        .circle-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; margin-bottom: 8px; }
        .yi .circle-icon { background: #32cd32; color: #000; box-shadow: 0 0 10px rgba(50,205,50,0.4); }
        .ji .circle-icon { background: #ff4500; color: #fff; box-shadow: 0 0 10px rgba(255,69,0,0.4); }
        .yiji-text { font-size: 0.85rem; color: #ddd; line-height: 1.4; }
        .ai-fortune-box { margin-top: 15px; background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(67, 97, 238, 0.1)); border: 1px solid rgba(124, 58, 237, 0.3); border-radius: 8px; padding: 15px; }
        .ai-title { font-size: 0.9rem; color: #a78bfa; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; font-weight: bold; }
        .ai-text { font-size: 0.85rem; color: #e2e8f0; line-height: 1.6; min-height: 40px; }
        .refresh-btn { width: 100%; background: transparent; border: 1px solid #334155; color: #94a3b8; margin-top: 10px; padding: 8px; font-size: 0.8rem; }
        .refresh-btn:hover { border-color: #a78bfa; color: #fff; }

        .life-panel { bottom: 110px; right: 30px; width: 500px; height: 450px; border: 1px solid rgba(239, 68, 68, 0.3); font-family: 'Noto Sans SC', sans-serif; }
        .life-header { padding: 15px; background: linear-gradient(90deg, #2b1212, #1a0f0f); border-bottom: 1px solid rgba(239, 68, 68, 0.3); border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .life-title { font-size: 1.1rem; font-weight: bold; color: #f87171; display: flex; align-items: center; gap: 8px; }
        .life-chart-container { flex: 1; position: relative; padding: 15px; background: #0b0d12; overflow: hidden; cursor: crosshair; }
        .life-analysis { height: 120px; padding: 15px; border-top: 1px solid #334155; overflow-y: auto; background: rgba(0,0,0,0.2); font-size: 0.8rem; color: #9ca3af; }
        canvas#lifeChart { width: 100%; height: 100%; }

        .liu-yao-panel { bottom: 110px; right: 30px; width: 340px; max-height: calc(100vh - 140px); border: 1px solid rgba(20, 184, 166, 0.3); overflow: hidden; }
        .liu-yao-header { padding: 15px; background: linear-gradient(90deg, #0f2e2e, #041f1f); border-bottom: 1px solid rgba(20, 184, 166, 0.3); border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .liu-yao-content { padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; flex: 1; min-height: 0; }
        .coins-container { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; perspective: 600px; }
        .coin { width: 70px; height: 70px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #e6be8a, #b8860b); box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 0 4px rgba(184, 134, 11, 0.6); display: flex; justify-content: center; align-items: center; position: relative; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: pointer; }
        .coin::before { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); pointer-events: none; }
        .coin-inner { width: 24px; height: 24px; background: #121926; border-radius: 2px; box-shadow: inset 2px 2px 2px rgba(0,0,0,0.5), 0 0 0 2px rgba(255,255,255,0.1); z-index: 2; }
        .coin.yang { background: radial-gradient(circle at 30% 30%, #ffd700, #daa520); box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 0 4px #ffd700; }
        .coin.yin { background: radial-gradient(circle at 30% 30%, #cd7f32, #8b4513); box-shadow: 0 4px 10px rgba(0,0,0,0.5), inset 0 0 0 4px #8b4513; }
        .shaking { animation: shake 0.6s ease-in-out; }
        .hexagram-display { width: 100%; margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; min-height: 180px; display: flex; flex-direction: column-reverse; gap: 8px; border: 1px solid #334155; }
        .hex-row { display: flex; align-items: center; justify-content: center; height: 20px; position: relative; }
        .hex-label { position: absolute; left: 0; font-size: 10px; color: #64748b; width: 20px; }
        .hex-line { width: 120px; height: 12px; border-radius: 2px; display: flex; justify-content: space-between; }
        .hex-line.yang { background: #38bdf8; }
        .hex-line.yin { background: transparent; }
        .hex-line.yin::before, .hex-line.yin::after { content: ''; display: block; width: 45%; height: 100%; background: #38bdf8; border-radius: 2px; }
        .move-marker { position: absolute; right: 10px; font-size: 12px; font-weight: bold; }
        .move-o { color: #ef4444; } .move-x { color: #ef4444; }
        .toss-btn { background: linear-gradient(135deg, #d97706, #b45309); border-color: #f59e0b; margin-top: 15px; }
        .reset-btn { width: 100%; margin-top: 10px; padding: 8px; background: transparent; border: 1px solid #334155; color: #94a3b8; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; }
        .reset-btn:hover { border-color: #ef4444; color: #ef4444; }

        .fab-container { position: absolute; bottom: 30px; right: 30px; display: flex; gap: 15px; z-index: 40; pointer-events: auto; transition: all 0.3s ease; }
        .fab { width: 64px; height: 64px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 28px; cursor: pointer; transition: transform 0.2s; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 5px 25px rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .fab:active { transform: scale(0.95); }
        .fab:hover { transform: scale(1.1); }
        .chat-fab { background: linear-gradient(135deg, #f72585, #4361ee); box-shadow: 0 5px 25px rgba(247, 37, 133, 0.4); }
        .calendar-fab { background: linear-gradient(135deg, #ffd700, #ff8c00); box-shadow: 0 5px 25px rgba(255, 140, 0, 0.4); }
        .kline-fab { background: linear-gradient(135deg, #ef4444, #b91c1c); box-shadow: 0 5px 25px rgba(220, 38, 38, 0.4); }
        .liuyao-fab { background: linear-gradient(135deg, #14b8a6, #0d9488); box-shadow: 0 5px 25px rgba(20, 184, 166, 0.4); }
        .handle-bar { width: 40px; height: 5px; background: rgba(255,255,255,0.2); border-radius: 5px; margin: 10px auto 5px auto; display: none; }

        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media (max-width: 768px) {
            /* Input Panel - Top Navigation Style */
            .input-panel {
                width: calc(100% - 30px);
                left: 15px; right: 15px; top: 15px;
                max-height: 70dvh; /* Use dvh for mobile address bar adjustment */
                z-index: 30;
                transform: none; 
                transition: max-height 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
                background: rgba(10, 15, 30, 0.9); /* More opaque */
            }
            .input-panel.collapsed {
                max-height: 60px;
                overflow: hidden;
            }
            
            /* Info Panel - Bottom Sheet Style */
            .info-panel {
                width: 100%; max-width: 100%;
                left: 0; right: 0; top: auto; bottom: 0;
                border-right: none;
                border-top: 1px solid rgba(255, 183, 3, 0.5); /* Gold top border */
                border-radius: 20px 20px 0 0;
                transform: translateY(110%);
                max-height: 65dvh;
                height: 65dvh;
                z-index: 35;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
                padding-bottom: env(safe-area-inset-bottom); /* iPhone X Safe Area */
            }
            .info-panel.active {
                transform: translateY(0);
            }
            .handle-bar { display: block; }

            /* Floating Windows - Full Screen/Sheet Style */
            .floating-window {
                width: 100% !important;
                max-width: 100% !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                border-radius: 20px 20px 0 0 !important;
                border: none !important;
                border-top: 1px solid rgba(255,255,255,0.2) !important;
                box-shadow: 0 -10px 40px rgba(0,0,0,0.8) !important;
                height: 80dvh !important; 
                max-height: 85dvh !important;
                z-index: 50 !important;
                display: flex; 
                padding-bottom: env(safe-area-inset-bottom);
            }

            /* FABs - Bottom Bar Style */
            .fab-container {
                bottom: 20px;
                width: 100%;
                justify-content: space-evenly;
                right: 0;
                padding-left: 10px;
                padding-right: 10px;
                padding-bottom: env(safe-area-inset-bottom);
                /* KEY FIX: Reduced z-index to sit BELOW open panels (z:35) on mobile */
                z-index: 18; 
                background: linear-gradient(to top, rgba(5,5,16,0.9), transparent); /* Gradual background */
            }
            .fab { width: 50px; height: 50px; font-size: 22px; margin: 0 5px; border-width: 1px; }
            
            /* Typography Tweaks */
            h1 { font-size: 1.1rem; }
            .panel-header { min-height: 50px; padding: 10px 15px; }
            
            /* 3D Canvas Adjust */
            #canvas-container { height: 100dvh; }
        }
    </style>
</head>
<body>

<div id="loading">
    <div class="planets">
        <div id="planetTrail1"></div>
        <div id="planetTrail2"></div>
        <div id="planetTrail3"></div>
        <div id="star"></div>
        <div id="starShadow"></div>
        <div id="blackHole"></div>
        <div id="blackHoleDisk1"></div>
        <div id="blackHoleDisk2"></div>
        <div id="planet"></div>
    </div>
    <p style="margin-top: 55px; color: #38bdf8; font-size: 0.9rem; letter-spacing: 2px; text-transform: uppercase;">æ˜Ÿç›˜æ’åˆ—ä¸­...</p>
</div>

<!-- Canvas -->
<div id="canvas-container"></div>

<!-- UI Layer -->
<div id="ui-layer">
    <!-- Input Panel (Top Left - Collapsible) -->
    <div class="panel input-panel" id="inputPanel">
        <!-- Header -->
        <div class="panel-header" onclick="toggleInputPanel()">
            <h1 class="flex items-center gap-2">ğŸŒŒ <span class="hidden sm:inline">ç´«å¾®æ˜Ÿç³»</span><span class="sm:hidden text-sm">æ˜Ÿé™…èˆ°é˜Ÿç‰ˆ</span></h1>
            <div class="toggle-icon">â–¼</div>
        </div>

        <!-- Content -->
        <div class="input-content">
            <p class="text-xs text-blue-300 mb-6 opacity-70 font-mono hidden sm:block">Star Fleet Visualization</p>
            
            <label>å‡ºç”Ÿæ—¥æœŸ (é˜³å†)</label>
            <input type="date" id="birthDate" value="1990-06-15">
            
            <label>å‡ºç”Ÿæ—¶è¾°</label>
            <select id="birthHour">
                <option value="0">å­æ—¶ (23:00-01:00)</option>
                <option value="1">ä¸‘æ—¶ (01:00-03:00)</option>
                <option value="2">å¯…æ—¶ (03:00-05:00)</option>
                <option value="3">å¯æ—¶ (05:00-07:00)</option>
                <option value="4">è¾°æ—¶ (07:00-09:00)</option>
                <option value="5">å·³æ—¶ (09:00-11:00)</option>
                <option value="6" selected>åˆæ—¶ (11:00-13:00)</option>
                <option value="7">æœªæ—¶ (13:00-15:00)</option>
                <option value="8">ç”³æ—¶ (15:00-17:00)</option>
                <option value="9">é…‰æ—¶ (17:00-19:00)</option>
                <option value="10">æˆŒæ—¶ (19:00-21:00)</option>
                <option value="11">äº¥æ—¶ (21:00-23:00)</option>
            </select>

            <label>æ€§åˆ«</label>
            <select id="gender">
                <option value="1">ç”· (ä¹¾é€ )</option>
                <option value="0">å¥³ (å¤é€ )</option>
            </select>

            <button class="uiverse" onclick="generateChart()">
                <div class="wrapper">
                    <span>ğŸš€ å¼€å¯æ˜Ÿç›˜</span>
                    <div class="circle circle-12"></div>
                    <div class="circle circle-11"></div>
                    <div class="circle circle-10"></div>
                    <div class="circle circle-9"></div>
                    <div class="circle circle-8"></div>
                    <div class="circle circle-7"></div>
                    <div class="circle circle-6"></div>
                    <div class="circle circle-5"></div>
                    <div class="circle circle-4"></div>
                    <div class="circle circle-3"></div>
                    <div class="circle circle-2"></div>
                    <div class="circle circle-1"></div>
                </div>
            </button>
            
            <div id="bureau-info" class="mt-6 text-xs text-blue-200 border-t border-blue-900 pt-3 hidden flex justify-between font-mono">
                <!-- Bureau info -->
            </div>
        </div>
    </div>

    <!-- Info Panel (Right or Bottom) -->
    <div class="panel info-panel" id="infoPanel">
        <!-- Handle for mobile swipe hint -->
        <div class="handle-bar"></div>
        
        <!-- Header -->
        <div class="panel-header" onclick="toggleInfoPanel()">
            <div class="flex flex-col">
                <h2 id="panelTitle">å®«ä½åç§°</h2>
                <div class="text-xs text-blue-300 font-mono" id="panelSub">ç‚¹å‡»æ˜Ÿå²›æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
            <div class="toggle-icon">â–¼</div>
        </div>

        <!-- Scrollable Content -->
        <div class="info-scroll">
            <div class="w-full h-px bg-gradient-to-r from-transparent via-blue-500 to-transparent mb-4"></div>
            <div id="starList" class="space-y-2">
                <!-- Stars -->
            </div>
            
            <button class="ai-text-btn" data-text="âœ¨ é—®æ˜Ÿ AI æ·±åº¦è§£æ" onclick="analyzeCurrentPalace(); event.stopPropagation();">
                <span class="actual-text">&nbsp;âœ¨ é—®æ˜Ÿ AI æ·±åº¦è§£æ&nbsp;</span>
                <span aria-hidden="true" class="hover-text">&nbsp;âœ¨ é—®æ˜Ÿ AI æ·±åº¦è§£æ&nbsp;</span>
            </button>
        </div>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="fab-container">
    <div class="fab liuyao-fab" onclick="toggleLiuYaoPanel()" title="å…­çˆ»èµ·å¦">ğŸ¢</div>
    <div class="fab calendar-fab" onclick="toggleDailyPanel()" title="ä»Šæ—¥æ˜Ÿå†">ğŸ“…</div>
    <div class="fab kline-fab" onclick="toggleLifePanel()" title="äººç”Ÿå¤§è¿Kçº¿">ğŸ“ˆ</div>
    <div class="fab chat-fab" onclick="toggleChat()" title="å‘½ç†å’¨è¯¢">âœ¨</div>
</div>

<!-- Daily Calendar Panel -->
<div class="floating-window calendar-panel" id="dailyPanel">
    <div class="handle-bar"></div>
    <div class="cal-header">
        <span class="close-modal" style="top: 15px; right: 15px; font-size: 20px;" onclick="toggleDailyPanel()">âœ•</span>
        <div class="cal-date-big" id="calSolarDate">--</div>
        <div class="cal-lunar" id="calLunarDate">--</div>
        <div class="cal-ganzhi" id="calGanzhi">--</div>
    </div>
    <div class="cal-body">
        <div class="yiji-grid">
            <div class="yiji-box yi">
                <div class="circle-icon">å®œ</div>
                <div class="yiji-text" id="calYi">...</div>
            </div>
            <div class="yiji-box ji">
                <div class="circle-icon">å¿Œ</div>
                <div class="yiji-text" id="calJi">...</div>
            </div>
        </div>
        <div class="ai-fortune-box">
            <div class="ai-title">
                <span>ğŸ”® ä»Šæ—¥è¿ç¨‹å‚è€ƒ</span>
            </div>
            <div class="ai-text" id="calAiText">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œç»“åˆæ‚¨çš„å‘½ç›˜è¿›è¡Œæ¨æ¼”...</div>
            <button class="refresh-btn" onclick="generateDailyReport()">âœ¨ æ¨æ¼”ä»Šæ—¥è¿ç¨‹</button>
        </div>
    </div>
</div>

<!-- Life K-Line Panel -->
<div class="floating-window life-panel" id="lifePanel">
    <div class="handle-bar"></div>
    <div class="life-header">
        <div class="life-title">ğŸ“ˆ äººç”Ÿå¤§è¿ K çº¿å›¾</div>
        <span class="cursor-pointer text-gray-400 hover:text-white" onclick="toggleLifePanel()">âœ•</span>
    </div>
    <div class="life-chart-container">
        <canvas id="lifeChart"></canvas>
    </div>
    <div class="life-analysis" id="lifeAnalysisText">
        <div class="animate-pulse text-gray-500">è¯·å…ˆç”Ÿæˆæ˜Ÿç›˜ï¼Œç³»ç»Ÿå°†ä¾æ®ã€Šæ¸Šæµ·å­å¹³ã€‹ä¸ã€Šå­å¹³çœŸè¯ ã€‹çš„æœˆä»¤æçº²æ³•ï¼Œç»“åˆå¤§è¿æµå¹´ä¸ºæ‚¨æ¨æ¼”ä¸€ç”Ÿèµ·ä¼...</div>
    </div>
</div>

<!-- Liu Yao Panel -->
<div class="floating-window liu-yao-panel" id="liuYaoPanel">
    <div class="handle-bar"></div>
    <div class="liu-yao-header">
        <div class="life-title" style="color: #2dd4bf;">å…­çˆ»èµ·å¦</div>
        <span class="cursor-pointer text-gray-400 hover:text-white" onclick="toggleLiuYaoPanel()">âœ•</span>
    </div>
    <div class="liu-yao-content">
        <div class="text-xs text-gray-400 mb-4 text-center">è¯šå¿ƒé»˜å¿µæ‰€é—®ä¹‹äº‹ï¼Œç‚¹å‡»ä¸‹æ–¹é“œé’±èµ·å¦ã€‚<br>(å…±éœ€æ‘‡å…­æ¬¡ï¼Œå½“å‰ç¬¬ <span id="yaoCount" class="text-teal-400 font-bold">0</span>/6 çˆ»)</div>
        
        <div class="coins-container" onclick="tossCoins()">
            <div class="coin" id="coin1"><div class="coin-inner"></div></div>
            <div class="coin" id="coin2"><div class="coin-inner"></div></div>
            <div class="coin" id="coin3"><div class="coin-inner"></div></div>
        </div>

        <div class="hexagram-display" id="hexDisplay">
            <div class="text-center text-gray-600 mt-10">ç­‰å¾…èµ·å¦...</div>
        </div>

        <button class="toss-btn" id="tossBtn" onclick="tossCoins()">ğŸ¤² æ‘‡ä¸€å¦</button>
        <button class="ai-btn hidden" id="interpretBtn" onclick="interpretHexagram()" style="padding: 6px; font-size: 0.85rem; margin-top: 10px;">âœ¨ é—®æ˜Ÿ AI è§£å¦</button>
        <button class="reset-btn" onclick="resetHexagram()">ğŸ”„ é‡ç½®å¦è±¡</button>
    </div>
</div>

<!-- Chat Window -->
<div class="floating-window chat-window" id="chatWindow">
    <div class="handle-bar"></div>
    <div class="chat-header">
        <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-400">AI å‘½ç†å¤§å¸ˆå’¨è¯¢å®¤</span>
        <span class="cursor-pointer text-gray-400 hover:text-white" onclick="toggleChat()">âœ•</span>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="msg msg-ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å‘½ç†åŠ©æ‰‹ã€‚æˆ‘å·²ç»è¯»å–äº†ä½ çš„å…¨ç›˜æ•°æ®ï¼Œä½ å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºäº‹ä¸šã€æ„Ÿæƒ…æˆ–æµå¹´çš„é—®é¢˜ã€‚</div>
    </div>
    <div class="chat-input-area">
        <input type="text" class="chat-input" id="userQuery" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." onkeypress="handleChatKey(event)">
        <button style="margin:0; width:auto; padding: 8px 12px; background: #4361ee; color:white; border-radius:6px;" onclick="askMaster()">å‘é€</button>
    </div>
</div>

<!-- AI Result Modal -->
<div id="ai-modal" class="modal-overlay">
    <div class="ai-content">
        <span class="close-modal" onclick="closeAiModal()">&times;</span>
        <h2 class="text-xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400">âœ¨ æ˜Ÿæ›œå¯ç¤º</h2>
        <div id="ai-result-text" class="markdown-body text-sm">
            æ­£åœ¨é€šè¿‡æ˜Ÿé™…ç½‘ç»œè¿æ¥ AI å¤§å¸ˆ...
        </div>
    </div>
</div>

<script>
    // --- GEMINI/WORKER API CONFIG ---
    // Replaced Gemini API with custom Worker API (Qwen)
    
    async function callAI(prompt, systemInstruction = "") {
        const url = `https://yuzai.chenrenhan91.workers.dev/api/generate`;
        
        // Combine system instruction and prompt if both exist
        const fullPrompt = systemInstruction ? `${systemInstruction}\n\n${prompt}` : prompt;
        
        const payload = {
            prompt: fullPrompt
        };

        const maxRetries = 3;
        let delay = 1000;

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const status = response.status;
                    console.error("AI API Error:", status);
                    throw new Error(`HTTP error! status: ${status}`);
                }
                
                const data = await response.json();
                
                if (data && data.ok && data.text) {
                    return data.text;
                } else {
                    console.error("Worker API returned error or invalid format", data);
                    throw new Error("API returned invalid data format");
                }
                
            } catch (error) {
                console.error("Attempt", i+1, "failed:", error);
                if (i === maxRetries - 1) return `è¿æ¥å®‡å®™èƒ½é‡å¤±è´¥ (API Error: ${error.message})ã€‚è¯·ç¨åå†è¯•ã€‚`;
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
        }
    }

    // --- ZI WEI DOU SHU LOGIC ---
    const HEAVENLY_STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
    const EARTHLY_BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const PALACE_NAMES = ['å‘½å®«', 'å…„å¼Ÿ', 'å¤«å¦»', 'å­å¥³', 'è´¢å¸›', 'ç–¾å„', 'è¿ç§»', 'ä»†å½¹', 'å®˜ç¦„', 'ç”°å®…', 'ç¦å¾·', 'çˆ¶æ¯'];
    
    function getBureau(stemIdx, branchIdx) {
        const NAYIN_BUREAU = [
             4, 4, 6, 6, 3, 3, 5, 5, 4, 4, 6, 6, 
             2, 2, 6, 6, 5, 5, 3, 3, 2, 2, 5, 5, 
             6, 6, 5, 5, 3, 3, 2, 2, 4, 4, 6, 6, 
             4, 4, 3, 3, 2, 2, 6, 6, 5, 5, 3, 3, 
             3, 3, 4, 4, 6, 6, 2, 2, 3, 3, 2, 2 
        ];
        
        for(let i=0; i<60; i++) {
            if (i % 10 === stemIdx && i % 12 === branchIdx) {
                return NAYIN_BUREAU[i];
            }
        }
        return 2; 
    }

    const SI_HUA_RULES = {
        0: { Lu:'å»‰è´', Quan:'ç ´å†›', Ke:'æ­¦æ›²', Ji:'å¤ªé˜³' }, 
        1: { Lu:'å¤©æœº', Quan:'å¤©æ¢', Ke:'ç´«å¾®', Ji:'å¤ªé˜´' }, 
        2: { Lu:'å¤©åŒ', Quan:'å¤©æœº', Ke:'æ–‡æ˜Œ', Ji:'å»‰è´' }, 
        3: { Lu:'å¤ªé˜´', Quan:'å¤©åŒ', Ke:'å¤©æœº', Ji:'å·¨é—¨' }, 
        4: { Lu:'è´ªç‹¼', Quan:'å¤ªé˜´', Ke:'å³å¼¼', Ji:'å¤©æœº' }, 
        5: { Lu:'æ­¦æ›²', Quan:'è´ªç‹¼', Ke:'å¤©æ¢', Ji:'æ–‡æ›²' }, 
        6: { Lu:'å¤ªé˜³', Quan:'æ­¦æ›²', Ke:'å¤ªé˜´', Ji:'å¤©åŒ' }, 
        7: { Lu:'å·¨é—¨', Quan:'å¤ªé˜³', Ke:'æ–‡æ›²', Ji:'æ–‡æ˜Œ' }, 
        8: { Lu:'å¤©æ¢', Quan:'ç´«å¾®', Ke:'å·¦è¾…', Ji:'æ­¦æ›²' }, 
        9: { Lu:'ç ´å†›', Quan:'å·¨é—¨', Ke:'å¤ªé˜´', Ji:'è´ªç‹¼' } 
    };

    const MAIN_STARS_INFO = {
        'ç´«å¾®': { type: 'å¸ç‹', color: '#a020f0', desc: 'å°Šè´µã€é¢†å¯¼ã€è§£å„ã€‚å…¨ç›˜ä¸­æ¢ã€‚' },
        'å¤©æœº': { type: 'æ™ºæ…§', color: '#4caf50', desc: 'æœºæ™ºã€å˜åŠ¨ã€è°‹ç•¥ã€‚' },
        'å¤ªé˜³': { type: 'æƒè´µ', color: '#ff9800', desc: 'åšçˆ±ã€åå£°ã€ä»˜å‡ºã€‚' },
        'æ­¦æ›²': { type: 'è´¢å¯Œ', color: '#ffd700', desc: 'åˆšæ¯…ã€å†³æ–­ã€æ­£è´¢ã€‚' },
        'å¤©åŒ': { type: 'ç¦æ°”', color: '#03a9f4', desc: 'æ¸©é¡ºã€äº«ä¹ã€åè°ƒã€‚' },
        'å»‰è´': { type: 'å›šæ˜Ÿ', color: '#ff4444', desc: 'æ¬¡æ¡ƒèŠ±ã€å¤æ‚ã€è¡Œæ”¿ã€‚' },
        'å¤©åºœ': { type: 'è´¢åº“', color: '#d2b48c', desc: 'åŒ…å®¹ã€ä¿å®ˆã€æŒè´¢ã€‚' },
        'å¤ªé˜´': { type: 'æ¯æ€§', color: '#88ccff', desc: 'æ¸©æŸ”ã€ç”°å®…ã€è´¢å¯Œã€‚' },
        'è´ªç‹¼': { type: 'æ¬²æœ›', color: '#ff69b4', desc: 'æ¡ƒèŠ±ã€æŠ•æœºã€å¤šæ‰ã€‚' },
        'å·¨é—¨': { type: 'æ˜¯é', color: '#708090', desc: 'å£æ‰ã€æš—æ˜§ã€ç ”ç©¶ã€‚' },
        'å¤©ç›¸': { type: 'å°æ˜Ÿ', color: '#4682b4', desc: 'è¾…ä½ã€å…¬æ­£ã€çˆ±ç¾ã€‚' },
        'å¤©æ¢': { type: 'è«æ˜Ÿ', color: '#556b2f', desc: 'è€äººã€åŸåˆ™ã€åŒ»è¯ã€‚' },
        'ä¸ƒæ€': { type: 'å°†æ˜Ÿ', color: '#cd5c5c', desc: 'è‚ƒæ€ã€å˜åŠ¨ã€ç‹¬ç«‹ã€‚' },
        'ç ´å†›': { type: 'è€—æ˜Ÿ', color: '#191970', desc: 'ç ´åã€å…ˆç ´åç«‹ã€‚' }
    };

    const STAR_BRIGHTNESS_TABLE = {
        'ç´«å¾®': ['å¹³', 'åº™', 'åº™', 'æ—º', 'å¾—', 'å¾—', 'åº™', 'åº™', 'æ—º', 'å¹³', 'å¾—', 'æ—º'],
        'å¤©æœº': ['åº™', 'é™·', 'å¾—', 'æ—º', 'åˆ©', 'å¹³', 'åº™', 'é™·', 'å¾—', 'æ—º', 'åˆ©', 'å¹³'],
        'å¤ªé˜³': ['é™·', 'é™·', 'æ—º', 'åº™', 'æ—º', 'æ—º', 'åº™', 'å¾—', 'å¾—', 'å¹³', 'é™·', 'é™·'],
        'æ­¦æ›²': ['æ—º', 'åº™', 'å¾—', 'é™·', 'åº™', 'å¹³', 'æ—º', 'åº™', 'å¾—', 'é™·', 'åº™', 'å¹³'],
        'å¤©åŒ': ['æ—º', 'é™·', 'å¹³', 'åº™', 'å¹³', 'åº™', 'é™·', 'é™·', 'æ—º', 'å¹³', 'å¹³', 'åº™'],
        'å»‰è´': ['å¹³', 'åˆ©', 'åº™', 'å¹³', 'åˆ©', 'é™·', 'å¹³', 'åˆ©', 'åº™', 'å¹³', 'åˆ©', 'é™·'],
        'å¤©åºœ': ['åº™', 'åº™', 'åº™', 'å¹³', 'åº™', 'å¾—', 'æ—º', 'åº™', 'å¾—', 'å¹³', 'åº™', 'å¾—'],
        'å¤ªé˜´': ['åº™', 'åº™', 'é™·', 'é™·', 'é™·', 'é™·', 'é™·', 'å¹³', 'åˆ©', 'æ—º', 'æ—º', 'åº™'],
        'è´ªç‹¼': ['æ—º', 'åº™', 'å¹³', 'å¹³', 'åº™', 'é™·', 'æ—º', 'åº™', 'å¹³', 'å¹³', 'åº™', 'é™·'],
        'å·¨é—¨': ['æ—º', 'æ—º', 'åº™', 'åº™', 'é™·', 'é™·', 'æ—º', 'é™·', 'åº™', 'åº™', 'é™·', 'æ—º'], 
        'å¤©ç›¸': ['åº™', 'åº™', 'åº™', 'é™·', 'æ—º', 'å¹³', 'åº™', 'å¾—', 'åº™', 'é™·', 'æ—º', 'å¹³'],
        'å¤©æ¢': ['åº™', 'æ—º', 'åº™', 'åº™', 'æ—º', 'é™·', 'åº™', 'æ—º', 'é™·', 'å¾—', 'æ—º', 'é™·'],
        'ä¸ƒæ€': ['æ—º', 'åº™', 'åº™', 'æ—º', 'åº™', 'å¹³', 'æ—º', 'åº™', 'åº™', 'æ—º', 'æ—º', 'å¹³'],
        'ç ´å†›': ['åº™', 'æ—º', 'é™·', 'é™·', 'æ—º', 'å¹³', 'åº™', 'æ—º', 'é™·', 'é™·', 'æ—º', 'å¹³']
    };

    class ZWDSChart {
        constructor(dateStr, hourIdx, genderVal) {
            this.gregorianDate = new Date(`${dateStr}T12:00:00`);
            this.gender = parseInt(genderVal); 
            const solar = Solar.fromDate(this.gregorianDate);
            this.lunar = solar.getLunar();
            this.lunarYear = this.lunar.getYear();
            this.lunarMonth = this.lunar.getMonth();
            this.lunarDay = this.lunar.getDay();
            this.lunarHourIdx = parseInt(hourIdx);
            this.yearStemIdx = this.lunar.getYearGanIndex(); 
            this.yearBranchIdx = this.lunar.getYearZhiIndex(); 
            this.chartData = [];
            this.initChart();
        }

        initChart() {
            let month = this.lunarMonth;
            if (month < 0) month = -month; 
            let hour = this.lunarHourIdx + 1; 
            let mingIndex = (2 + (month - 1) - (hour - 1)) % 12;
            if (mingIndex < 0) mingIndex += 12;
            let shenIndex = (2 + (month - 1) + (hour - 1)) % 12;
            
            for (let i = 0; i < 12; i++) {
                let offset = (mingIndex - i) % 12;
                if (offset < 0) offset += 12;
                let yinStemBase = (this.yearStemIdx % 5) * 2 + 2; 
                if (yinStemBase > 9) yinStemBase -= 10;
                let distFromYin = offset - 2;
                if (distFromYin < 0) distFromYin += 12;
                let palaceStem = (yinStemBase + distFromYin) % 10;
                this.chartData[offset] = {
                    name: PALACE_NAMES[i],
                    branch: EARTHLY_BRANCHES[offset],
                    stem: HEAVENLY_STEMS[palaceStem],
                    stars: [],
                    isMing: (i === 0),
                    isShen: (offset === shenIndex),
                    bureau: 0 
                };
            }
            
            const mingPalace = this.chartData[mingIndex];
            const mingStemIdx = HEAVENLY_STEMS.indexOf(mingPalace.stem);
            const mingBranchIdx = EARTHLY_BRANCHES.indexOf(mingPalace.branch);
            this.bureau = getBureau(mingStemIdx, mingBranchIdx);
            
            let day = this.lunarDay;
            let bureau = this.bureau;
            let Q, pos;
            if (day % bureau === 0) {
                Q = day / bureau;
                pos = 2 + Q - 1;
            } else {
                let rem = day % bureau;
                let add = bureau - rem; 
                Q = (day + add) / bureau;
                if (add % 2 !== 0) {
                    pos = 2 + Q - 1 - add; 
                } else {
                    pos = 2 + Q - 1 + add; 
                }
            }
            while(pos < 0) pos += 12;
            pos = pos % 12;
            this.ziWeiIdx = pos;
            this.tianFuIdx = (4 - this.ziWeiIdx + 12) % 12;
            
            this.placeStars();
            this.placeSiHua();
            this.calcBrightness();
        }
        
        placeStars() {
            const place = (star, offset) => {
                let idx = (this.ziWeiIdx + offset + 120) % 12; 
                this.addStar(idx, star, 'main');
            };
            place('ç´«å¾®', 0);
            place('å¤©æœº', -1);
            place('å¤ªé˜³', -3);
            place('æ­¦æ›²', -4);
            place('å¤©åŒ', -5);
            place('å»‰è´', -8);
            
            const placeTF = (star, offset) => {
                let idx = (this.tianFuIdx + offset + 120) % 12;
                this.addStar(idx, star, 'main');
            };
            placeTF('å¤©åºœ', 0);
            placeTF('å¤ªé˜´', 1);
            placeTF('è´ªç‹¼', 2);
            placeTF('å·¨é—¨', 3);
            placeTF('å¤©ç›¸', 4);
            placeTF('å¤©æ¢', 5);
            placeTF('ä¸ƒæ€', 6);
            placeTF('ç ´å†›', 10);
            
            let zuoFu = (4 + (this.lunarMonth - 1)) % 12;
            if (zuoFu < 0) zuoFu += 12; 
            this.addStar(zuoFu, 'å·¦è¾…', 'lucky');
            let youBi = (10 - (this.lunarMonth - 1) + 12) % 12;
            this.addStar(youBi, 'å³å¼¼', 'lucky');
            let wenChang = (10 - (this.lunarHourIdx) + 12) % 12;
            this.addStar(wenChang, 'æ–‡æ˜Œ', 'lucky');
            let wenQu = (4 + this.lunarHourIdx) % 12;
            this.addStar(wenQu, 'æ–‡æ›²', 'lucky');
            
            const luCunMap = {0:2, 1:3, 2:5, 3:6, 4:5, 5:6, 6:8, 7:9, 8:11, 9:0}; 
            const luCunPos = luCunMap[this.yearStemIdx];
            if (luCunPos !== undefined) {
                this.addStar(luCunPos, 'ç¦„å­˜', 'lucky');
                this.addStar((luCunPos + 1) % 12, 'æ“ç¾Š', 'bad');
                this.addStar((luCunPos - 1 + 12) % 12, 'é™€ç½—', 'bad');
            }
        }
        
        addStar(idx, name, category) {
            if (!this.chartData[idx]) return; 
            this.chartData[idx].stars.push({ name, category, brightness: 'å¹³' });
        }
        
        placeSiHua() {
            const rules = SI_HUA_RULES[this.yearStemIdx];
            if (!rules) return;
            this.chartData.forEach(palace => {
                palace.stars.forEach(star => {
                    if (star.name === rules.Lu) star.sihua = 'ç¦„';
                    if (star.name === rules.Quan) star.sihua = 'æƒ';
                    if (star.name === rules.Ke) star.sihua = 'ç§‘';
                    if (star.name === rules.Ji) star.sihua = 'å¿Œ';
                });
            });
        }
        
        calcBrightness() {
            this.chartData.forEach((palace, pIdx) => {
                const branchIdx = EARTHLY_BRANCHES.indexOf(palace.branch);
                palace.stars.forEach(star => {
                    if (star.category === 'main') {
                        if (STAR_BRIGHTNESS_TABLE[star.name]) {
                            star.brightness = STAR_BRIGHTNESS_TABLE[star.name][branchIdx];
                        } else {
                            star.brightness = 'å¹³'; 
                        }
                    }
                });
            });
        }
        
        getSummary() {
            let summary = `ç”¨æˆ·æ€§åˆ«: ${this.gender === 1 ? 'ç”·' : 'å¥³'}ã€‚\n`;
            summary += `äº”è¡Œå±€: ${this.bureau}å±€ã€‚\n`;
            summary += `å‘½ç›˜ç»“æ„:\n`;
            this.chartData.forEach(p => {
                const starStr = p.stars.map(s => {
                    let info = `${s.name}(${s.brightness})`;
                    if (s.sihua) info += `[åŒ–${s.sihua}]`;
                    return info;
                }).join(', ');
                summary += `- ${p.name} (${p.stem}${p.branch}): ${starStr || 'æ— ä¸»æ˜Ÿ'}\n`;
            });
            return summary;
        }
    }

    // --- LIFE K-LINE ---
    let latestLifeData = []; 
    let currentDrawLimit = 0; 
    let lifeAnimFrameId = null; 

    function getBaZiInfo(date, hourIdx) {
        const d = new Date(date);
        const hrs = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
        d.setHours(hrs[parseInt(hourIdx)] || 12);
        const solar = Solar.fromDate(d);
        const lunar = solar.getLunar();
        const bazi = lunar.getEightChar();
        return {
            dayStem: bazi.getDayGan(),
            monthBranch: bazi.getMonthZhi(),
            monthStem: bazi.getMonthGan(),
            yearBranch: bazi.getYearZhi(),
            baziObj: bazi,
            lunar: lunar
        };
    }

    function calculateLifeTrendData(birthDateStr, hourIdx, gender) {
        const d = new Date(birthDateStr);
        const hrs = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
        d.setHours(hrs[parseInt(hourIdx)]);
        const solar = Solar.fromDate(d);
        const lunar = solar.getLunar();
        const eightChar = lunar.getEightChar();
        const monthZhi = eightChar.getMonthZhi(); 
        
        const seasons = { 'å¯…': 'Spring', 'å¯': 'Spring', 'è¾°': 'Spring', 'å·³': 'Summer', 'åˆ': 'Summer', 'æœª': 'Summer', 'ç”³': 'Autumn', 'é…‰': 'Autumn', 'æˆŒ': 'Autumn', 'äº¥': 'Winter', 'å­': 'Winter', 'ä¸‘': 'Winter' };
        const season = seasons[monthZhi];
        let favorElements = [];
        if (season === 'Winter') favorElements = ['ç«', 'æœ¨']; 
        else if (season === 'Summer') favorElements = ['æ°´', 'é‡‘']; 
        else if (season === 'Spring') favorElements = ['ç«', 'é‡‘']; 
        else if (season === 'Autumn') favorElements = ['æ°´', 'æœ¨']; 
        
        const yun = lunar.getEightChar().getYun(parseInt(gender));
        const daYunArr = yun.getDaYun();
        let qiYunAge = 0;
        if (daYunArr.length > 0) {
            qiYunAge = daYunArr[0].getStartAge();
        }

        let kLineData = [];
        const elMap = { 'ç”²':'æœ¨','ä¹™':'æœ¨','å¯…':'æœ¨','å¯':'æœ¨', 'ä¸™':'ç«','ä¸':'ç«','å·³':'ç«','åˆ':'ç«', 'æˆŠ':'åœŸ','å·±':'åœŸ','è¾°':'åœŸ','æˆŒ':'åœŸ','ä¸‘':'åœŸ','æœª':'åœŸ', 'åºš':'é‡‘','è¾›':'é‡‘','ç”³':'é‡‘','é…‰':'é‡‘', 'å£¬':'æ°´','ç™¸':'æ°´','äº¥':'æ°´','å­':'æ°´' };

        for (let i = 0; i < daYunArr.length; i++) { 
            const dy = daYunArr[i]; 
            if (!dy) continue; 
            const daYunGanZhi = dy.getGanZhi();
            const gan = daYunGanZhi.charAt(0);
            const zhi = daYunGanZhi.charAt(1);
            let daYunScore = 0;
            const ganEl = elMap[gan];
            const zhiEl = elMap[zhi];
            if (favorElements.includes(ganEl)) daYunScore += 5; else daYunScore -= 2;
            if (favorElements.includes(zhiEl)) daYunScore += 5; else daYunScore -= 2;
            const clashes = { 'å­':'åˆ', 'åˆ':'å­', 'ä¸‘':'æœª', 'æœª':'ä¸‘', 'å¯…':'ç”³', 'ç”³':'å¯…', 'å¯':'é…‰', 'é…‰':'å¯', 'è¾°':'æˆŒ', 'æˆŒ':'è¾°', 'å·³':'äº¥', 'äº¥':'å·³' };
            let isClash = (clashes[monthZhi] === zhi);
            const liunians = dy.getLiuNian(); 
            
            for (let j = 0; j < liunians.length; j++) {
                const liunian = liunians[j];
                const a = liunian.getAge(); 
                if (a < qiYunAge) continue;
                if (a > 100) break;
                const lnGanZhi = liunian.getGanZhi();
                const lnGan = lnGanZhi.charAt(0);
                const lnZhi = lnGanZhi.charAt(1);
                let yearlyMod = 0;
                if (favorElements.includes(elMap[lnGan])) yearlyMod += 5; else yearlyMod -= 2;
                if (favorElements.includes(elMap[lnZhi])) yearlyMod += 5; else yearlyMod -= 2;
                if (clashes[monthZhi] === lnZhi) yearlyMod -= 10;
                if (isClash) yearlyMod += (Math.random() > 0.5 ? 8 : -8);
                
                let prevClose = kLineData.length > 0 ? kLineData[kLineData.length-1].close : 50;
                let idealScore = 50 + (daYunScore * 2) + yearlyMod;
                let open = prevClose;
                let close = open + (idealScore - open) * 0.3; 
                let volatility = 5;
                if (isClash) volatility += 10;
                if (clashes[lnZhi] === monthZhi) volatility += 10; 
                let high = Math.max(open, close) + Math.random() * volatility;
                let low = Math.min(open, close) - Math.random() * volatility;
                if(high > 100) high = 100; if(low < 0) low = 0;
                
                kLineData.push({ age: a, year: liunian.getYear(), ganZhi: lnGanZhi, open: Math.floor(open), close: Math.floor(close), high: Math.floor(high), low: Math.floor(low), daYun: `${gan}${zhi}` });
            }
        }
        latestLifeData = kLineData; 
        return kLineData;
    }

    function renderLifeKLine(data, highlightIndex = -1, drawLimit = data.length) {
        const canvas = document.getElementById('lifeChart');
        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr; canvas.height = rect.height * dpr;
        ctx.scale(dpr, dpr);
        const w = rect.width; const h = rect.height;
        ctx.fillStyle = "#0b0d12"; ctx.fillRect(0, 0, w, h);
        const padding = 20; const paddingBottom = 40; 
        const graphW = w - padding * 2; const graphH = h - padding - paddingBottom;
        const barW = graphW / data.length;

        ctx.strokeStyle = "#1e293b"; ctx.lineWidth = 1;
        for(let i=0; i<=5; i++) { let y = padding + i * (graphH/5); ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(w - padding, y); ctx.stroke(); }
        
        for (let i = 0; i < drawLimit && i < data.length; i++) {
            const d = data[i]; const x = padding + i * barW;
            const mapY = (val) => h - paddingBottom - (val / 100 * graphH);
            const yOpen = mapY(d.open); const yClose = mapY(d.close); const yHigh = mapY(d.high); const yLow = mapY(d.low);
            const isRise = d.close >= d.open;
            ctx.fillStyle = isRise ? "#ef4444" : "#10b981"; ctx.strokeStyle = isRise ? "#ef4444" : "#10b981";
            
            if (i === highlightIndex) {
                ctx.save(); ctx.strokeStyle = "#ffffff"; ctx.setLineDash([5, 5]); ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(x + barW/2, padding); ctx.lineTo(x + barW/2, h - paddingBottom); ctx.stroke();
                ctx.restore();
            }
            ctx.beginPath(); ctx.moveTo(x + barW/2, yHigh); ctx.lineTo(x + barW/2, yLow); ctx.stroke();
            const bodyH = Math.abs(yClose - yOpen); const bodyY = Math.min(yOpen, yClose);
            ctx.fillRect(x + 0.5, bodyY, Math.max(barW - 1, 0.5), Math.max(bodyH, 1)); 

            if (d.age >= 10 && d.age <= 80 && d.age % 10 === 0) {
                ctx.fillStyle = "#94a3b8"; ctx.font = "10px sans-serif"; ctx.textAlign = "center"; ctx.fillText(d.age + "å²", x + barW/2, h - 10);
            }
        }
        
        if (drawLimit > 0) {
            ctx.beginPath(); ctx.strokeStyle = "#fbbf24"; ctx.lineWidth = 2;
            for (let i = 0; i < drawLimit && i < data.length; i++) {
                const d = data[i]; const x = padding + i * barW + barW/2; const mapY = (val) => h - paddingBottom - (val / 100 * graphH); const y = mapY(d.close);
                if (i===0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
        }

        if (highlightIndex !== -1 && highlightIndex < drawLimit && data[highlightIndex]) {
            const d = data[highlightIndex];
            const x = padding + highlightIndex * barW + barW/2;
            const y = 50; 
            const tipText = `${d.age}å² Â· ${d.year}å¹´ (${d.ganZhi}) Â· å¤§è¿: ${d.daYun}`;
            ctx.font = "bold 14px sans-serif"; const textWidth = ctx.measureText(tipText).width;
            let tipX = x - textWidth/2; if (tipX < padding) tipX = padding; if (tipX + textWidth > w - padding) tipX = w - padding - textWidth;
            ctx.fillStyle = "rgba(0, 0, 0, 0.8)"; ctx.fillRect(tipX - 10, y - 20, textWidth + 20, 30);
            ctx.strokeStyle = "#fbbf24"; ctx.strokeRect(tipX - 10, y - 20, textWidth + 20, 30);
            ctx.fillStyle = "#ffffff"; ctx.textAlign = "left"; ctx.fillText(tipText, tipX, y);
        }
    }

    function startLifeChartAnimation(data) {
        if (lifeAnimFrameId) cancelAnimationFrame(lifeAnimFrameId);
        const duration = 2000; const startTime = performance.now(); currentDrawLimit = 0;
        function loop(now) {
            const elapsed = now - startTime; const progress = Math.min(elapsed / duration, 1);
            currentDrawLimit = Math.floor(data.length * progress);
            renderLifeKLine(data, -1, currentDrawLimit);
            if (progress < 1) lifeAnimFrameId = requestAnimationFrame(loop);
            else { currentDrawLimit = data.length; renderLifeKLine(data, -1, currentDrawLimit); }
        }
        lifeAnimFrameId = requestAnimationFrame(loop);
    }

    function setupChartInteraction() {
        const canvas = document.getElementById('lifeChart');
        canvas.addEventListener('mousemove', (e) => {
            if (latestLifeData.length === 0) return;
            const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left; handleInteraction(x, rect.width);
        });
        canvas.addEventListener('mouseleave', () => { renderLifeKLine(latestLifeData, -1, currentDrawLimit); });
        canvas.addEventListener('touchmove', (e) => {
            if (latestLifeData.length === 0) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect(); const x = e.touches[0].clientX - rect.left; handleInteraction(x, rect.width);
        }, { passive: false });
        canvas.addEventListener('touchend', () => { renderLifeKLine(latestLifeData, -1, currentDrawLimit); });
        
        function handleInteraction(x, width) {
            const padding = 20; const graphW = width - padding * 2; const barW = graphW / latestLifeData.length;
            let index = Math.floor((x - padding) / barW);
            if (index < 0) index = 0; if (index >= latestLifeData.length) index = latestLifeData.length - 1;
            renderLifeKLine(latestLifeData, index, currentDrawLimit);
        }
    }

    function toggleLifePanel() {
        const panel = document.getElementById('lifePanel');
        closeAllFloatingWindows(panel);
        
        if (panel.style.display === 'flex') {
            panel.style.display = 'none';
        } else {
            panel.style.display = 'flex';
            generateLifeChartLogic();
            setupChartInteraction();
        }
    }
    
    // Helper to close other windows
    function closeAllFloatingWindows(except = null) {
        const windows = ['dailyPanel', 'lifePanel', 'liuYaoPanel', 'chatWindow', 'settings-modal'];
        windows.forEach(id => {
            const el = document.getElementById(id);
            if (el && el !== except && el.id !== 'ai-modal') el.style.display = 'none';
        });
    }

    function generateLifeChartLogic() {
        const dateStr = document.getElementById('birthDate').value;
        const hourIdx = document.getElementById('birthHour').value;
        const gender = document.getElementById('gender').value;
        const data = calculateLifeTrendData(dateStr, hourIdx, gender);
        startLifeChartAnimation(data);
        const info = getBaZiInfo(dateStr, hourIdx);
        const monthZhi = info.monthBranch; const dayGan = info.dayStem;
        const nowYear = new Date().getFullYear();
        const birthYear = new Date(dateStr).getFullYear();
        const currentAge = nowYear - birthYear;
        const currentData = data.find(d => d.age === currentAge) || data[data.length-1];
        const daYunStr = currentData ? currentData.daYun : "--";
        const analysisDiv = document.getElementById('lifeAnalysisText');
        analysisDiv.innerHTML = `<div class="mb-2"><strong class="text-white">å½“å‰å¤§è¿:</strong> <span class="text-yellow-400 text-lg">${daYunStr}</span> (çº¦${currentAge}å²)</div><div class="mb-2"><strong class="text-white">æœˆä»¤æçº²:</strong> ${monthZhi}æœˆ (æ ¼å±€æ ¸å¿ƒ)</div><div><strong class="text-blue-400">å¤§å¸ˆæ‰¹æ³¨:</strong> æ­¤é€ æ—¥å…ƒä¸º<span class="text-white">${dayGan}</span>ï¼Œç”Ÿäº${monthZhi}æœˆã€‚ä¾æ®ã€Šå­å¹³çœŸè¯ ã€‹ï¼Œæœˆä»¤ä¸ºæçº²ä¹‹åºœï¼Œå†³å®šäººç”Ÿæ ¼å±€ä¸Šé™ã€‚å½“å‰è¡Œè¿è‡³<span class="text-yellow-400">${daYunStr}</span>ï¼Œéœ€æ³¨æ„å¤§è¿åœ°æ”¯ä¸æœˆä»¤çš„åˆ‘å†²åˆå®³å…³ç³»ã€‚è‹¥Kçº¿éœ‡è¡å‰§çƒˆï¼ˆçº¢ç»¿äº¤æ›¿é¢‘ç¹ï¼‰ï¼Œä»£è¡¨æµå¹´å¼•åŠ¨äº†å±€ä¸­éšæ‚£ï¼Œåä¸ºâ€œè¿å†²æçº²â€æˆ–â€œå²è¿å¹¶ä¸´â€ï¼Œå»ºè®®è¯¥é˜¶æ®µå®ˆæˆä¸»é™ï¼Œé¡ºåº”å¤©æ—¶ã€‚</div>`;
    }

    // --- LIU YAO LOGIC ---
    let currentYaoLines = []; 
    let isTossing = false;
    const HEX_64 = {
        '111111': 'ä¹¾ä¸ºå¤©', '000000': 'å¤ä¸ºåœ°', '100010': 'æ°´é›·å±¯', '010001': 'å±±æ°´è’™', '111010': 'æ°´å¤©éœ€', '010111': 'å¤©æ°´è®¼', '010000': 'åœ°æ°´å¸ˆ', '000010': 'æ°´åœ°æ¯”',
        '111011': 'é£å¤©å°ç•œ', '110111': 'å¤©æ³½å±¥', '111000': 'åœ°å¤©æ³°', '000111': 'å¤©åœ°å¦', '101111': 'å¤©ç«åŒäºº', '111101': 'ç«å¤©å¤§æœ‰', '001000': 'åœ°å±±è°¦', '000100': 'é›·åœ°è±«',
        '100110': 'æ³½é›·éš', '011001': 'å±±é£è›Š', '110000': 'åœ°æ³½ä¸´', '000011': 'é£åœ°è§‚', '100101': 'ç«é›·å™¬å—‘', '101001': 'å±±ç«è´²', '000001': 'å±±åœ°å‰¥', '100000': 'åœ°é›·å¤',
        '100111': 'å¤©é›·æ— å¦„', '111001': 'å±±å¤©å¤§ç•œ', '100001': 'å±±é›·é¢', '011110': 'æ³½é£å¤§è¿‡', '010010': 'åä¸ºæ°´', '101101': 'ç¦»ä¸ºç«', '001110': 'æ³½å±±å’¸', '011100': 'é›·é£æ’',
        '001111': 'å¤©å±±é', '111100': 'é›·å¤©å¤§å£®', '000101': 'ç«åœ°æ™‹', '101000': 'åœ°ç«æ˜å¤·', '101010': 'é£ç«å®¶äºº', '010101': 'ç«æ³½ç½', '001010': 'æ°´å±±è¹‡', '010100': 'é›·æ°´è§£',
        '110001': 'å±±æ³½æŸ', '100011': 'é£é›·ç›Š', '111110': 'æ³½å¤©å¤¬', '011111': 'å¤©é£å§¤', '000110': 'æ³½åœ°èƒ', '011000': 'åœ°é£å‡', '010110': 'æ³½æ°´å›°', '011010': 'æ°´é£äº•',
        '101110': 'æ³½ç«é©', '011101': 'ç«é£é¼', '100100': 'éœ‡ä¸ºé›·', '001001': 'è‰®ä¸ºå±±', '001011': 'é£å±±æ¸', '110100': 'é›·æ³½å½’å¦¹', '101100': 'é›·ç«ä¸°', '001101': 'ç«å±±æ—…',
        '011011': 'å·½ä¸ºé£', '110110': 'å…‘ä¸ºæ³½', '010011': 'é£æ°´æ¶£', '110010': 'æ°´æ³½èŠ‚', '110011': 'é£æ³½ä¸­å­š', '001100': 'é›·å±±å°è¿‡', '101011': 'æ°´ç«æ—¢æµ', '110101': 'ç«æ°´æœªæµ'
    };

    function toggleLiuYaoPanel() {
        const panel = document.getElementById('liuYaoPanel');
        closeAllFloatingWindows(panel);
        if (panel.style.display === 'flex') panel.style.display = 'none';
        else panel.style.display = 'flex';
    }

    function tossCoins() {
        if (isTossing || currentYaoLines.length >= 6) return;
        isTossing = true;
        const coins = document.querySelectorAll('.coin');
        coins.forEach(c => c.classList.add('shaking'));
        setTimeout(() => {
            coins.forEach(c => c.classList.remove('shaking'));
            let sum = 0;
            for(let i=0; i<3; i++) {
                const isYang = Math.random() > 0.5;
                sum += isYang ? 3 : 2;
                const coinEl = document.getElementById(`coin${i+1}`);
                if (isYang) { coinEl.classList.remove('yin'); coinEl.classList.add('yang'); }
                else { coinEl.classList.remove('yang'); coinEl.classList.add('yin'); }
            }
            let yao = { val: sum, isMoving: (sum===6 || sum===9), type: (sum%2!==0) ? 1 : 0 }; 
            currentYaoLines.push(yao);
            document.getElementById('yaoCount').innerText = currentYaoLines.length;
            renderHexagramLines();
            if (currentYaoLines.length === 6) {
                document.getElementById('tossBtn').style.display = 'none';
                document.getElementById('interpretBtn').classList.remove('hidden');
                document.getElementById('interpretBtn').classList.add('flex');
            }
            isTossing = false;
        }, 600);
    }

    function resetHexagram() {
        currentYaoLines = [];
        document.getElementById('yaoCount').innerText = '0';
        document.getElementById('hexDisplay').innerHTML = '<div class="text-center text-gray-600 mt-10">ç­‰å¾…èµ·å¦...</div>';
        document.getElementById('tossBtn').style.display = 'block';
        document.getElementById('interpretBtn').classList.add('hidden');
        document.getElementById('interpretBtn').classList.remove('flex');
        const coins = document.querySelectorAll('.coin');
        coins.forEach(c => { c.classList.remove('yang'); c.classList.remove('yin'); });
        isTossing = false;
    }

    function renderHexagramLines() {
        const container = document.getElementById('hexDisplay');
        container.innerHTML = ''; 
        currentYaoLines.forEach((yao, idx) => {
            const row = document.createElement('div'); row.className = 'hex-row';
            const label = document.createElement('div'); label.className = 'hex-label'; label.innerText = (idx + 1); 
            const line = document.createElement('div'); line.className = 'hex-line ' + (yao.type === 1 ? 'yang' : 'yin');
            row.appendChild(label); row.appendChild(line);
            if (yao.isMoving) {
                const marker = document.createElement('div'); marker.className = 'move-marker ' + (yao.val === 9 ? 'move-o' : 'move-x'); marker.innerText = (yao.val === 9 ? 'O' : 'X'); row.appendChild(marker);
            }
            container.appendChild(row);
        });
        if (currentYaoLines.length === 6) {
            const binStr = [...currentYaoLines].reverse().map(y => y.type).join('');
            const name = HEX_64[binStr] || "æœªçŸ¥å¦";
            const infoDiv = document.createElement('div'); infoDiv.className = "text-center text-yellow-400 font-bold mt-2"; infoDiv.innerHTML = `<div>æœ¬å¦: ${name}</div>`;
            container.appendChild(infoDiv);
        }
    }

    async function interpretHexagram() {
        const binStr = [...currentYaoLines].reverse().map(y => y.type).join('');
        const benGuaName = HEX_64[binStr] || "æœªçŸ¥å¦";
        const zhiLines = currentYaoLines.map(y => { if (y.val === 6) return 1; if (y.val === 9) return 0; return y.type; });
        const zhiBinStr = [...zhiLines].reverse().join('');
        const zhiGuaName = HEX_64[zhiBinStr] || "æœªçŸ¥å¦";
        const movingLinesDesc = currentYaoLines.map((y, i) => { if (!y.isMoving) return null; return `ç¬¬${i+1}çˆ»å‘åŠ¨ (${y.val === 9 ? 'è€é˜³' : 'è€é˜´'})`; }).filter(x => x).join(', ');
        const modal = document.getElementById('ai-modal');
        const contentDiv = document.getElementById('ai-result-text');
        modal.style.display = 'flex';
        contentDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10">
                <div class="spinner">
                    <div class="spinner1"></div>
                </div>
                <p class="mt-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 animate-pulse font-bold tracking-widest">
                    ğŸŒŒ æ˜Ÿè¾°è¿ç»“ä¸­...
                </p>
                <p class="text-xs text-gray-500 mt-2">æ­£åœ¨ä»¥æ­¤å¦é—®è¯¢å¤©æœº</p>
            </div>
        `;
        const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šã€Šå¢åˆ åœæ˜“ã€‹ä¸ä¼ ç»Ÿçº³ç”²ç­®æ³•çš„å…­çˆ»å‘½ç†å¤§å¸ˆã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æ‘‡å‡ºçš„é‡‘é’±è¯¾å¦è±¡ï¼ˆæœ¬å¦ã€åŠ¨çˆ»ã€å˜å¦ï¼‰è¿›è¡Œä¸“ä¸šè§£è¯»ã€‚è§£è¯»è¦æ±‚ï¼š1. å‡†ç¡®åˆ†æå¦åã€äº”è¡Œã€ä¸–åº”å…³ç³»ã€‚2. é‡ç‚¹åˆ†æåŠ¨çˆ»ï¼ˆè€é˜´/è€é˜³ï¼‰çš„å‰å‡¶å˜åŒ–ï¼ŒåŠ¨çˆ»æ˜¯äº‹æƒ…æˆè´¥çš„å…³é”®ã€‚3. ç»“åˆå˜å¦åˆ¤æ–­äº‹æƒ…çš„æœ€ç»ˆèµ°å‘ã€‚4. è¯­æ°”ä¸“ä¸šã€ç¥ç§˜ä½†å®¢è§‚ï¼Œç»™å‡ºå…·ä½“çš„è¡ŒåŠ¨å»ºè®®ã€‚5. è¾“å‡ºæ ¼å¼ä½¿ç”¨ Markdownï¼Œå…³é”®å‰å‡¶ç»“è®ºè¯·åŠ ç²—ã€‚`;
        const userPrompt = `ç”¨æˆ·èµ·å¦ç»“æœå¦‚ä¸‹ï¼šã€æœ¬å¦ã€‘: ${benGuaName} (ç»“æ„: ${binStr}) ã€åŠ¨çˆ»ã€‘: ${movingLinesDesc || "é™å¦æ— åŠ¨çˆ»"} ã€å˜å¦/ä¹‹å¦ã€‘: ${zhiGuaName} è¯·å¼€å§‹è§£å¦ã€‚`;
        const result = await callAI(userPrompt, systemPrompt);
        contentDiv.innerHTML = marked.parse(result);
    }

    // --- THREE.JS ---
    let scene, camera, renderer, controls, raycaster, mouse;
    let chartObj = new THREE.Group();
    let connectionGroup = new THREE.Group(); 
    let coreMesh, coreUniforms, sectorMeshes = []; 

    function init3D() {
        const container = document.getElementById('canvas-container');
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x02040a, 0.0015);
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0, -60, 45);
        camera.lookAt(0, 0, 0);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        container.appendChild(renderer.domElement);
        controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05;
        controls.maxDistance = 150; controls.minDistance = 20;
        
        const ambientLight = new THREE.AmbientLight(0x222244); scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffaa00, 2, 200); sunLight.position.set(0, 0, 0); scene.add(sunLight);
        const blueLight = new THREE.PointLight(0x0088ff, 1.5, 100); blueLight.position.set(30, 30, 30); scene.add(blueLight);

        // Particle System (Optimization: reduce count on mobile)
        const isMobile = window.innerWidth < 768;
        const particleCount = isMobile ? 8000 : 20000; 
        const positions = new Float32Array(particleCount * 3); const randoms = new Float32Array(particleCount); const radius = 3.8; 
        for (let i = 0; i < particleCount; i++) {
            const k = i + 0.5; const phi = Math.acos(1 - 2 * k / particleCount); const theta = Math.PI * (1 + Math.sqrt(5)) * k;
            const x = radius * Math.sin(phi) * Math.cos(theta); const y = radius * Math.sin(phi) * Math.sin(theta); const z = radius * Math.cos(phi);
            positions[i * 3] = x; positions[i * 3 + 1] = y; positions[i * 3 + 2] = z; randoms[i] = Math.random();
        }
        const coreGeo = new THREE.BufferGeometry(); coreGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3)); coreGeo.setAttribute('aRandom', new THREE.BufferAttribute(randoms, 1));
        coreUniforms = { uTime: { value: 0 }, uColor1: { value: new THREE.Color(0x050505) }, uColor2: { value: new THREE.Color(0xffffff) } };
        const vertexShader = `
            uniform float uTime; attribute float aRandom; varying vec3 vPos; varying float vRandom;
            vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
            vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
            vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
            vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
            float snoise(vec3 v) { const vec2 C = vec2(1.0/6.0, 1.0/3.0); const vec4 D = vec4(0.0, 0.5, 1.0, 2.0); vec3 i = floor(v + dot(v, C.yyy)); vec3 x0 = v - i + dot(i, C.xxx); vec3 g = step(x0.yzx, x0.xyz); vec3 l = 1.0 - g; vec3 i1 = min(g.xyz, l.zxy); vec3 i2 = max(g.xyz, l.zxy); vec3 x1 = x0 - i1 + C.xxx; vec3 x2 = x0 - i2 + C.yyy; vec3 x3 = x0 - D.yyy; i = mod289(i); vec4 p = permute(permute(permute(i.z + vec4(0.0, i1.z, i2.z, 1.0)) + i.y + vec4(0.0, i1.y, i2.y, 1.0)) + i.x + vec4(0.0, i1.x, i2.x, 1.0)); float n_ = 0.142857142857; vec3 ns = n_ * D.wyz - D.xzx; vec4 j = p - 49.0 * floor(p * ns.z * ns.z); vec4 x_ = floor(j * ns.z); vec4 y_ = floor(j - 7.0 * x_); vec4 x = x_ * ns.x + ns.yyyy; vec4 y = y_ * ns.x + ns.yyyy; vec4 h = 1.0 - abs(x) - abs(y); vec4 b0 = vec4(x.xy, y.xy); vec4 b1 = vec4(x.zw, y.zw); vec4 s0 = floor(b0) * 2.0 + 1.0; vec4 s1 = floor(b1) * 2.0 + 1.0; vec4 sh = -step(h, vec4(0.0)); vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy; vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww; vec3 p0 = vec3(a0.xy, h.x); vec3 p1 = vec3(a0.zw, h.y); vec3 p2 = vec3(a1.xy, h.z); vec3 p3 = vec3(a1.zw, h.w); vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3))); p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w; vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0); m = m * m; return 42.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3))); }
            void main() { vRandom = aRandom; vec3 noisePos = position * 0.5 + vec3(0.0, uTime * 0.2, 0.0); float noiseVal = snoise(noisePos); vec3 newPos = position + normalize(position) * noiseVal * 0.2; vPos = newPos; vec4 mvPosition = modelViewMatrix * vec4(newPos, 1.0); gl_Position = projectionMatrix * mvPosition; float sizePulse = 1.0 + sin(uTime * 2.0 + aRandom * 10.0) * 0.3; gl_PointSize = (6.0 * sizePulse + aRandom * 2.0) * (30.0 / -mvPosition.z); }
        `;
        const fragmentShader = `
            uniform float uTime; uniform vec3 uColor1; uniform vec3 uColor2; varying vec3 vPos; varying float vRandom;
            float random(vec2 st) { return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123); }
            vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; } vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; } vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }
            float snoise(vec2 v) { const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439); vec2 i = floor(v + dot(v, C.yy)); vec2 x0 = v - i + dot(i, C.xx); vec2 i1; i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0); vec4 x12 = x0.xyxy + C.xxzz; x12.xy -= i1; i = mod289(i); vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0)); vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0); m = m * m; m = m * m; vec3 x = 2.0 * fract(p * C.www) - 1.0; vec3 h = abs(x) - 0.5; vec3 ox = floor(x + 0.5); vec3 a0 = x - ox; m *= 1.79284291400159 - 0.85373472095314 * (a0 * a0 + h * h); vec3 g; g.x = a0.x * x0.x + h.x * x0.y; g.yz = a0.yz * x12.xz + h.yz * x12.yw; return 130.0 * dot(m, g); }
            void main() { vec2 coord = gl_PointCoord - vec2(0.5); float dist = length(coord); if(dist > 0.5) discard; vec3 normPos = normalize(vPos); float angle = -uTime * 0.2; float cosA = cos(angle); float sinA = sin(angle); vec2 rotated = vec2(normPos.x * cosA - normPos.y * sinA, normPos.x * sinA + normPos.y * cosA); float x = rotated.x; float y = rotated.y; float timeStep = floor(uTime * 15.0) / 15.0; float noise = snoise(vec2(y * 10.0, timeStep)) * 0.1; float blocky = floor(noise * 20.0) / 20.0; float curve = -sin(y * 3.14159) * 0.4; float boundary = curve + blocky; float mixVal = step(boundary, x); vec2 topEyePos = vec2(0.0, 0.5); vec2 botEyePos = vec2(0.0, -0.5); float eyeNoise = snoise(vec2(uTime * 2.0, 0.0)) * 0.005; float dTop = length(vec2(x, y) - topEyePos); float dBot = length(vec2(x, y) - botEyePos); float rEye = 0.12 + eyeNoise; float inTopEye = 1.0 - smoothstep(rEye - 0.02, rEye + 0.02, dTop); float inBotEye = 1.0 - smoothstep(rEye - 0.02, rEye + 0.02, dBot); float finalMix = clamp(mixVal - inTopEye + inBotEye, 0.0, 1.0); float alpha = 1.0 - smoothstep(0.3, 0.5, dist); vec3 col = vec3(0.0); if (finalMix > 0.5) { col = vec3(0.9, 0.95, 1.0) * 1.5; col += vec3(1.0) * smoothstep(0.0, 0.2, 0.5 - dist); alpha *= 0.8 + 0.2 * sin(uTime * 5.0 + vRandom * 10.0); } else { col = vec3(0.02, 0.02, 0.02); float gridX = step(0.95, fract(vPos.x * 2.0 + uTime * 0.1)); float gridY = step(0.95, fract(vPos.y * 2.0)); col += vec3(0.3) * (gridX + gridY) * 0.5; alpha = smoothstep(0.0, 0.2, alpha); alpha = 1.0; } float scan = sin(gl_FragCoord.y * 0.5 + uTime * 10.0); if(scan > 0.9) col *= 1.3; else col *= 0.9; gl_FragColor = vec4(col, alpha); }
        `;
        const coreMat = new THREE.ShaderMaterial({ uniforms: coreUniforms, vertexShader: vertexShader, fragmentShader: fragmentShader, transparent: true, depthWrite: false, blending: THREE.NormalBlending });
        coreMesh = new THREE.Points(coreGeo, coreMat);
        const coreGlow = createGlowSprite(0xaaccff, 18); coreGlow.material.opacity = 0.15; coreMesh.add(coreGlow); scene.add(coreMesh);
        
        addBackgroundStars(); addSpaceDust();
        chartObj.add(connectionGroup); scene.add(chartObj);
        raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();
        window.addEventListener('resize', onWindowResize, false);
        window.addEventListener('click', onMouseClick, false);
        
        // Initial mobile camera check
        onWindowResize();

        animate();
    }

    function addBackgroundStars() {
        const geometry = new THREE.BufferGeometry(); const vertices = []; const colors = []; const colorObj = new THREE.Color();
        for (let i = 0; i < 3000; i++) {
            vertices.push(THREE.MathUtils.randFloatSpread(400), THREE.MathUtils.randFloatSpread(400), THREE.MathUtils.randFloatSpread(400));
            colorObj.setHSL(0.6 + Math.random() * 0.1, 0.8, 0.5 + Math.random() * 0.5); colors.push(colorObj.r, colorObj.g, colorObj.b);
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3)); geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
        const material = new THREE.PointsMaterial({ size: 0.6, vertexColors: true, transparent: true, opacity: 0.8 });
        const stars = new THREE.Points(geometry, material); scene.add(stars);
    }
    
    function addSpaceDust() {
        const geometry = new THREE.BufferGeometry(); const vertices = [];
        for (let i = 0; i < 1500; i++) {
            const r = 30 + Math.random() * 60; const theta = Math.random() * Math.PI * 2;
            const x = r * Math.cos(theta); const y = r * Math.sin(theta); const z = (Math.random() - 0.5) * 15; vertices.push(x, y, z);
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
        const material = new THREE.PointsMaterial({ color: 0x4466aa, size: 0.4, transparent: true, opacity: 0.4 });
        const dust = new THREE.Points(geometry, material); dust.name = "dust"; scene.add(dust);
    }

    function clearChart3D() {
        while(chartObj.children.length > 0){ chartObj.remove(chartObj.children[0]); }
        sectorMeshes = [];
        while(connectionGroup.children.length > 0){ connectionGroup.remove(connectionGroup.children[0]); }
        chartObj.add(connectionGroup); 
    }

    function createSectorMesh(index, data) {
        const radiusInner = 16; const radiusOuter = 28; const segments = 12;
        const thetaStart = (index * 2 * Math.PI) / segments; const thetaLength = (2 * Math.PI) / segments - 0.15;
        const shape = new THREE.Shape(); shape.absarc(0, 0, radiusOuter, thetaStart, thetaStart + thetaLength, false); shape.absarc(0, 0, radiusInner, thetaStart + thetaLength, thetaStart, true);
        const extrudeSettings = { depth: 1.5, bevelEnabled: true, bevelThickness: 0.2, bevelSize: 0.2, bevelSegments: 3 };
        const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
        let baseColor = data.isMing ? 0x0077ff : 0x223344; let emissiveColor = data.isMing ? 0x002244 : 0x000000; let opacityVal = 0.6;
        if (data.isShen) { baseColor = 0x00aa88; opacityVal = 0.7; }
        const material = new THREE.MeshPhysicalMaterial({ color: baseColor, transparent: true, opacity: opacityVal, metalness: 0.8, roughness: 0.2, clearcoat: 1.0, clearcoatRoughness: 0.1, emissive: emissiveColor, emissiveIntensity: 0.5, side: THREE.DoubleSide });
        const mesh = new THREE.Mesh(geometry, material); mesh.userData = { id: index, data: data, originalColor: baseColor, originalEmissive: emissiveColor }; 
        const labelText = data.name + '\n' + data.stem + data.branch;
        const sprite = createTextSprite(labelText, data.isMing ? 0xffd700 : 0xaaccff);
        const angle = thetaStart + thetaLength / 2; const r = (radiusInner + radiusOuter) / 2;
        sprite.position.set(r * Math.cos(angle), r * Math.sin(angle), 5); mesh.add(sprite);
        if (data.isMing) { const glow = createGlowSprite(0x0077ff, 12); glow.position.set(r * Math.cos(angle), r * Math.sin(angle), -2); mesh.add(glow); }
        addStarsToSector(mesh, data.stars, angle, r);
        sectorMeshes[index] = mesh; return mesh;
    }

    function addStarsToSector(parentMesh, stars, angle, radius) {
        stars.forEach((star, i) => {
            let size = 0.4; let color = 0xffffff; let intensity = 1.0;
            if (star.category === 'main') {
                size = 1.0; color = MAIN_STARS_INFO[star.name] ? MAIN_STARS_INFO[star.name].color : 0xffffff; intensity = 1.5;
                switch (star.brightness) {
                    case 'åº™': size = 1.6; intensity = 4.0; break;
                    case 'æ—º': size = 1.3; intensity = 2.5; break;
                    case 'å¾—': case 'åˆ©': size = 1.1; intensity = 1.8; break;
                    case 'å¹³': size = 0.9; intensity = 1.0; break;
                    case 'é™·': case 'é—²': size = 0.6; intensity = 0.4; const c = new THREE.Color(color); c.lerp(new THREE.Color(0x333333), 0.5); color = c.getHex(); break;
                    default: size = 1.0; intensity = 1.0;
                }
            } else if (star.category === 'bad') { color = 0xff4444; size = 0.5; } else if (star.category === 'lucky') { color = 0x44ff88; size = 0.5; }
            const geometry = new THREE.SphereGeometry(size, 32, 32); const material = new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: intensity, roughness: 0.1 });
            const starMesh = new THREE.Mesh(geometry, material);
            let rOffset = (Math.random() - 0.5) * 6; let hOffset = 4 + Math.random() * 4; let aOffset = (Math.random() - 0.5) * 0.15;
            let finalR = radius + rOffset; let finalA = angle + aOffset;
            starMesh.position.set(finalR * Math.cos(finalA), finalR * Math.sin(finalA), hOffset);
            const glow = createGlowSprite(color, size * 6); glow.position.copy(starMesh.position);
            parentMesh.add(starMesh); parentMesh.add(glow);
            if (star.sihua) {
                const ringGeo = new THREE.RingGeometry(size * 1.5, size * 1.8, 32);
                let ringColor = 0xffffff; if(star.sihua === 'ç¦„') ringColor = 0x4cc9f0; if(star.sihua === 'æƒ') ringColor = 0x4361ee; if(star.sihua === 'ç§‘') ringColor = 0xb5179e; if(star.sihua === 'å¿Œ') ringColor = 0xf72585;
                const ringMat = new THREE.MeshBasicMaterial({ color: ringColor, side: THREE.DoubleSide, transparent: true, opacity: 0.8, depthWrite: false });
                const ring = new THREE.Mesh(ringGeo, ringMat); ring.position.copy(starMesh.position); ring.lookAt(0,0,100); parentMesh.add(ring);
            }
        });
    }

    function createTextSprite(message, color) {
        const canvas = document.createElement('canvas'); const context = canvas.getContext('2d'); canvas.width = 512; canvas.height = 256;
        context.clearRect(0, 0, canvas.width, canvas.height); 
        context.font = "Bold 50px 'Noto Sans SC'"; context.fillStyle = "rgba(255,255,255,1)"; context.textAlign = "center"; context.textBaseline = "middle"; context.shadowColor = "#000"; context.shadowBlur = 15; context.lineWidth = 4;
        const lines = message.split('\n');
        lines.forEach((line, i) => { if (i===0) { context.fillStyle = '#' + new THREE.Color(color).getHexString(); context.font = "Bold 60px 'Noto Sans SC'"; context.fillText(line, 256, 100); } else { context.fillStyle = "#cccccc"; context.font = "40px 'Noto Sans SC'"; context.fillText(line, 256, 160); } });
        const texture = new THREE.CanvasTexture(canvas); const spriteMaterial = new THREE.SpriteMaterial({ map: texture, transparent: true, depthWrite: false });
        const sprite = new THREE.Sprite(spriteMaterial); sprite.scale.set(8, 4, 1); return sprite;
    }

    function createGlowSprite(color, scale) {
        const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64; const ctx = canvas.getContext('2d');
        const c = new THREE.Color(color); const r = Math.floor(c.r * 255); const g = Math.floor(c.g * 255); const b = Math.floor(c.b * 255);
        const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32); gradient.addColorStop(0, `rgba(${r},${g},${b},1)`); gradient.addColorStop(0.4, `rgba(${r},${g},${b},0.5)`); gradient.addColorStop(1, `rgba(${r},${g},${b},0)`);
        ctx.fillStyle = gradient; ctx.clearRect(0,0,64,64); ctx.fillRect(0, 0, 64, 64);
        const texture = new THREE.CanvasTexture(canvas); const mat = new THREE.SpriteMaterial({ map: texture, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
        const sprite = new THREE.Sprite(mat); sprite.scale.set(scale, scale, 1); return sprite;
    }
    
    function visualizeRelationships(centerIndex) {
        while(connectionGroup.children.length > 0){ connectionGroup.remove(connectionGroup.children[0]); }
        const trine1 = (centerIndex + 4) % 12; const trine2 = (centerIndex + 8) % 12; const opposite = (centerIndex + 6) % 12; const activeIndices = [centerIndex, trine1, trine2, opposite];
        sectorMeshes.forEach((mesh, i) => {
            if (activeIndices.includes(i)) {
                mesh.material.opacity = 0.8; mesh.material.emissiveIntensity = 0.8;
                if (i === centerIndex) mesh.material.emissive.setHex(0xffaa00); else if (i === opposite) mesh.material.emissive.setHex(0xff4444); else mesh.material.emissive.setHex(0x00aaff);
            } else { mesh.material.opacity = 0.2; mesh.material.emissiveIntensity = 0.1; mesh.material.emissive.setHex(mesh.userData.originalEmissive); }
        });
        const getPos = (idx) => {
            const segments = 12; const thetaStart = (idx * 2 * Math.PI) / segments; const thetaLength = (2 * Math.PI) / segments - 0.15; const angle = thetaStart + thetaLength / 2; const r = 22; return new THREE.Vector3(r * Math.cos(angle), r * Math.sin(angle), 3); 
        };
        const pCenter = getPos(centerIndex); const pTrine1 = getPos(trine1); const pTrine2 = getPos(trine2); const pOpposite = getPos(opposite);
        const trianglePoints = [pCenter, pTrine1, pTrine2, pCenter]; const triGeo = new THREE.BufferGeometry().setFromPoints(trianglePoints); const triMat = new THREE.LineBasicMaterial({ color: 0x00aaff, linewidth: 2, transparent: true, opacity: 0.8 }); const triangle = new THREE.Line(triGeo, triMat); connectionGroup.add(triangle);
        const oppPoints = [pCenter, pOpposite]; const oppGeo = new THREE.BufferGeometry().setFromPoints(oppPoints); const oppMat = new THREE.LineDashedMaterial({ color: 0xff4444, dashSize: 1, gapSize: 0.5, scale: 1, transparent: true, opacity: 0.8 }); const oppLine = new THREE.Line(oppGeo, oppMat); oppLine.computeLineDistances(); connectionGroup.add(oppLine);
        [pCenter, pTrine1, pTrine2, pOpposite].forEach((pos, idx) => { const color = idx === 3 ? 0xff4444 : (idx === 0 ? 0xffaa00 : 0x00aaff); const node = createGlowSprite(color, 8); node.position.copy(pos); connectionGroup.add(node); });
    }

    let currentChart = null; let selectedPalaceData = null;

    function generateChart() {
        document.getElementById('loading').style.display = 'flex'; document.getElementById('loading').style.opacity = 1;
        // Mobile UX: Collapse input panel automatically
        if (window.innerWidth <= 768) { document.getElementById('inputPanel').classList.add('collapsed'); }
        
        setTimeout(() => {
            const date = document.getElementById('birthDate').value; const hourIdx = document.getElementById('birthHour').value; const gender = document.getElementById('gender').value;
            try {
                currentChart = new ZWDSChart(date, hourIdx, gender);
                const bureaus = ['æ°´äºŒå±€', 'æœ¨ä¸‰å±€', 'é‡‘å››å±€', 'åœŸäº”å±€', 'ç«å…­å±€'];
                let bIdx = -1; if(currentChart.bureau === 2) bIdx = 0; if(currentChart.bureau === 3) bIdx = 1; if(currentChart.bureau === 4) bIdx = 2; if(currentChart.bureau === 5) bIdx = 3; if(currentChart.bureau === 6) bIdx = 4;
                const bText = bIdx >= 0 ? bureaus[bIdx] : 'æœªçŸ¥å±€';
                const bDiv = document.getElementById('bureau-info');
                bDiv.innerHTML = `<span>äº”è¡Œ: <strong class="text-white">${bText}</strong></span> <span>å‘½ä¸»: <strong class="text-white">${currentChart.chartData[0].stem}${currentChart.chartData[0].branch}</strong></span>`;
                bDiv.classList.remove('hidden');
                // Always reset chat to avoid persisting old context in a fresh chart
                document.getElementById('chatMessages').innerHTML = '<div class="msg msg-ai">ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI å‘½ç†åŠ©æ‰‹ã€‚æˆ‘å·²ç»è¯»å–äº†ä½ çš„å…¨ç›˜æ•°æ®ï¼Œä½ å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºäº‹ä¸šã€æ„Ÿæƒ…æˆ–æµå¹´çš„é—®é¢˜ã€‚</div>';
                
                renderChart3D(currentChart);
            } catch (e) { console.error(e); alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥è¾“å…¥æˆ–æ§åˆ¶å°æ—¥å¿—ã€‚"); }
            document.getElementById('loading').style.opacity = 0; setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 500);
        }, 2500); 
    }

    function renderChart3D(chart) {
        clearChart3D();
        chart.chartData.forEach((data, index) => { const sector = createSectorMesh(index, data); chartObj.add(sector); });
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        
        // --- MOBILE CAMERA ADJUSTMENT ---
        if (window.innerWidth < 768) {
            // Portrait/Mobile: Move camera back/up to fit the chart
            // Adjusted for better visibility of 3D tilt
            camera.position.set(0, -90, 80); // Adjusted for better viewing angle on mobile
        } else {
            // Desktop
            camera.position.set(0, -60, 45);
        }
        if (controls) controls.update();
    }

    function onMouseClick(event) {
        if (!currentChart) return;
        
        // Critical for Mobile: Use event coordinates directly
        // Use clientX/Y which works for both click and touch-simulated click
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(chartObj.children, true); 
        
        if (intersects.length > 0) {
            let target = intersects[0].object;
            while(target.parent && target.parent !== chartObj && !target.userData.data) { target = target.parent; }

            if (target.userData && target.userData.data) {
                const centerIndex = target.userData.id;
                const panel = document.getElementById('infoPanel');
                
                // Mobile Logic: 
                // 1. Open Info Panel (Slide up)
                panel.classList.add('active');
                panel.classList.remove('collapsed');
                
                showInfoPanel(target.userData.data);
                visualizeRelationships(centerIndex);
            }
        }
    }
    
    function showInfoPanel(data) {
        selectedPalaceData = data; 
        document.getElementById('panelTitle').innerText = data.name + ' (' + data.stem + data.branch + ')';
        const PALACE_DESC_MAP = {
            'å‘½å®«': 'æ ¸å¿ƒäººæ ¼ Â· å¤©èµ‹ç‰¹è´¨ Â· å‘½è¿æ€»è§ˆ', 'å…„å¼Ÿ': 'çŸ¥å¿ƒå¥½å‹ Â· åˆä½œä¼™ä¼´ Â· ç°é‡‘å‘¨è½¬', 'å¤«å¦»': 'æ„Ÿæƒ…æ¨¡å¼ Â· ä¼´ä¾£ç‰¹è´¨ Â· å©šå§»çŠ¶å†µ', 'å­å¥³': 'äº²å­å…³ç³» Â· æ™šè¾ˆç¼˜åˆ† Â· åˆä¼™äº‹ä¸š',
            'è´¢å¸›': 'èµšé’±èƒ½åŠ› Â· æ”¶å…¥æ¥æº Â· ç†è´¢è§‚å¿µ', 'ç–¾å„': 'èº«ä½“å¥åº· Â· æ½œæ„è¯† Â· æƒ…ç»ªå‹åŠ›', 'è¿ç§»': 'å¯¹å¤–å½¢è±¡ Â· ç¤¾äº¤æœºé‡ Â· å‡ºè¡Œè¿åŠ¿', 'ä»†å½¹': 'äººé™…åœˆå­ Â· ç²‰ä¸å—ä¼— Â· æœ‹å‹åŠ©åŠ›',
            'å®˜ç¦„': 'äº‹ä¸šå‘å±• Â· èŒåœºè¡¨ç° Â· åˆ›ä¸šæ–¹å‘', 'ç”°å®…': 'å±…ä½ç¯å¢ƒ Â· æˆ¿äº§è¿åŠ¿ Â· å®¶åº­æ°›å›´', 'ç¦å¾·': 'ç²¾ç¥äº«å— Â· å…´è¶£å—œå¥½ Â· è´¢æºèµ·ä¼', 'çˆ¶æ¯': 'é•¿è¾ˆç¼˜åˆ† Â· é—ä¼ åŸºå›  Â· ä¸Šå¸å…³ç³»'
        };
        let subText = PALACE_DESC_MAP[data.name] || 'æœªçŸ¥é¢†åŸŸ';
        if (data.isMing) { subText = 'ã€æœ¬å‘½æ ¸å¿ƒã€‘ ' + subText; document.getElementById('panelSub').className = "text-xs text-yellow-300 font-mono font-bold"; } else if (data.isShen) { subText = 'ã€åå¤©èº«å®«ã€‘ ' + subText; document.getElementById('panelSub').className = "text-xs text-green-300 font-mono font-bold"; } else { document.getElementById('panelSub').className = "text-xs text-blue-300 font-mono"; }
        document.getElementById('panelSub').innerText = subText;
        const list = document.getElementById('starList'); list.innerHTML = '';
        if (data.stars.length === 0) { list.innerHTML = '<div class="text-gray-500 text-sm">æ­¤å®«æ— ä¸»æ˜Ÿ (å€Ÿå¯¹å®«æ˜Ÿæ›œ)</div>'; } else {
            data.stars.sort((a,b) => { const order = { 'main': 1, 'lucky': 2, 'bad': 3 }; return order[a.category] - order[b.category]; });
            data.stars.forEach(star => {
                const item = document.createElement('div'); item.className = 'flex items-center justify-between bg-white bg-opacity-10 p-2 rounded';
                let sihuaTag = ''; if (star.sihua) { const cls = {'ç¦„':'sihua-lu', 'æƒ':'sihua-quan', 'ç§‘':'sihua-ke', 'å¿Œ':'sihua-ji'}[star.sihua]; sihuaTag = `<span class="${cls} mr-1">[åŒ–${star.sihua}]</span>`; }
                let brightCls = 'star-ping'; if (star.brightness === 'åº™') brightCls = 'star-miao'; else if (star.brightness === 'æ—º') brightCls = 'star-wang'; else if (star.brightness === 'å¾—') brightCls = 'star-de'; else if (star.brightness === 'åˆ©') brightCls = 'star-li'; else if (star.brightness === 'å¹³') brightCls = 'star-ping'; else if (star.brightness === 'é™·') brightCls = 'star-xian'; else if (star.brightness === 'é—²') brightCls = 'star-xian';
                const starInfo = MAIN_STARS_INFO[star.name] || {}; const desc = starInfo.desc || '';
                item.innerHTML = `<div><span class="font-bold text-base" style="color:${starInfo.color||'#fff'}">${star.name}</span>${sihuaTag}<div class="text-xs text-gray-400">${desc}</div></div><div class="flex flex-col items-end"><span class="star-tag ${brightCls}">${star.brightness}</span></div>`; list.appendChild(item);
            });
        }
    }
    
    function toggleInputPanel() {
        const panel = document.getElementById('inputPanel');
        panel.classList.toggle('collapsed');
        // Mobile Logic: Close Info Panel if Input Panel opens manually
        if (window.innerWidth <= 768 && !panel.classList.contains('collapsed')) {
            document.getElementById('infoPanel').classList.remove('active');
        }
    }

    function toggleInfoPanel() {
        const panel = document.getElementById('infoPanel');
        // Mobile: Just toggle active class for bottom sheet slide
        if (window.innerWidth <= 768) {
            panel.classList.toggle('active');
        } else {
            panel.classList.toggle('collapsed');
        }
    }

    // Daily Calendar Logic
    function getModernYiJi(dateStr, chart) {
        let hash = 0; for (let i = 0; i < dateStr.length; i++) { hash = ((hash << 5) - hash) + dateStr.charCodeAt(i); hash |= 0; }
        let userOffset = 0; let starPersonality = "general"; 
        if (chart) { userOffset = (chart.ziWeiIdx * 137) + (chart.bureau * 19); const mingPalace = chart.chartData.find(p => p.isMing); if (mingPalace) { const stars = mingPalace.stars.map(s => s.name); if (stars.includes('ä¸ƒæ€') || stars.includes('ç ´å†›') || stars.includes('è´ªç‹¼')) { starPersonality = "aggressive"; } else if (stars.includes('å¤©åŒ') || stars.includes('å¤ªé˜´') || stars.includes('å¤©æ¢')) { starPersonality = "gentle"; } } }
        const personalizedSeed = hash + userOffset;
        const commonYi = ["å†™ä»£ç ", "é‡æ„", "æäº¤PR", "æ‘¸é±¼", "å–å¥¶èŒ¶", "å¥èº«", "çº¦ä¼š", "è¡¨ç™½", "ç†è´¢", "å¸çŒ«", "æ—©ç¡", "é˜…è¯»", "å†¥æƒ³", "å¤§æ‰«é™¤", "å¬éŸ³ä¹", "çœ‹å±•", "å­¦ä¹ æ–°æ¡†æ¶", "å¤‡ä»½æ•°æ®", "å¤ç›˜", "æ–­èˆç¦»", "åšé¥­", "æ•£æ­¥", "ç©æ¸¸æˆ", "ç¡æ‡’è§‰"];
        const commonJi = ["ç†¬å¤œ", "ä¹±ç«‹Flag", "ç›´æ¥æ¨äº§", "è¿‡åº¦ç„¦è™‘", "å†…è€—", "åµæ¶", "å€Ÿé’±", "æš´é¥®æš´é£Ÿ", "ä¹…å", "ç›²ç›®è·Ÿé£", "å†²åŠ¨æ¶ˆè´¹", "å¿˜è®°ä¿å­˜", "æ‹–å»¶ç—‡", "å…«å¦", "æ— æ„ä¹‰ä¼šè®®", "å‰§é€", "è¿Ÿåˆ°", "å†·æˆ˜"];
        const aggroYi = ["æŒ‘æˆ˜æƒå¨", "æé™è¿åŠ¨", "åˆ›ä¸š", "å¤§é¢æŠ•èµ„", "é€šå®µå†²åˆº"]; const gentleYi = ["æ³¡è„š", "ç§èŠ±", "å†™æ—¥è®°", "åšSPA", "å¬è½»éŸ³ä¹"];
        let finalYi = [...commonYi]; let finalJi = [...commonJi];
        if (starPersonality === "aggressive") { finalYi.push(...aggroYi); } else if (starPersonality === "gentle") { finalYi.push(...gentleYi); }
        const pickItems = (pool, count, seedVal) => { let result = []; let tempPool = [...pool]; for (let i = 0; i < count; i++) { const rnd = Math.abs(Math.sin(seedVal + i * 13)) * 10000; const idx = Math.floor((rnd - Math.floor(rnd)) * tempPool.length); result.push(tempPool[idx]); tempPool.splice(idx, 1); } return result; };
        return { yi: pickItems(finalYi, 4, personalizedSeed), ji: pickItems(finalJi, 4, personalizedSeed + 42) };
    }
    
    function initDailyCalendar() {
        const now = new Date(); const lunar = Lunar.fromDate(now); const solar = Solar.fromDate(now);
        const dateStr = `${solar.getYear()}-${solar.getMonth()}-${solar.getDay()}`;
        document.getElementById('calSolarDate').innerText = `${solar.getYear()}å¹´${solar.getMonth()}æœˆ${solar.getDay()}æ—¥`;
        document.getElementById('calLunarDate').innerText = `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`;
        document.getElementById('calGanzhi').innerText = `${lunar.getYearInGanZhi()}å¹´ Â· ${lunar.getMonthInGanZhi()}æœˆ Â· ${lunar.getDayInGanZhi()}æ—¥`;
        const modernData = getModernYiJi(dateStr, currentChart);
        if (currentChart) { document.querySelector('.yiji-box.yi').style.border = "1px solid rgba(50, 205, 50, 0.6)"; document.querySelector('.yiji-box.ji').style.border = "1px solid rgba(255, 69, 0, 0.6)"; }
        document.getElementById('calYi').innerText = modernData.yi.join(' Â· '); document.getElementById('calJi').innerText = modernData.ji.join(' Â· ');
    }
    
    function toggleDailyPanel() {
        const panel = document.getElementById('dailyPanel');
        closeAllFloatingWindows(panel);
        if (panel.style.display === 'flex') { panel.style.display = 'none'; } else { panel.style.display = 'flex'; initDailyCalendar(); }
    }

    async function generateDailyReport() {
        const aiTextDiv = document.getElementById('calAiText');
        if (!currentChart) { aiTextDiv.innerText = "è¯·å…ˆåœ¨å·¦ä¾§è¾“å…¥ç”Ÿæ—¥å¹¶ç”Ÿæˆå‘½ç›˜ï¼Œä»¥ä¾¿å¤§å¸ˆä¸ºæ‚¨æ¨ç®—ä»Šæ—¥è¿åŠ¿ã€‚"; return; }
        aiTextDiv.innerHTML = '<span class="animate-pulse">å¤§å¸ˆæ­£åœ¨ææŒ‡ä¸€ç®—...</span>';
        const now = new Date(); const lunar = Lunar.fromDate(now);
        const todayInfo = { date: `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`, lunar: `${lunar.getMonthInChinese()}æœˆ${lunar.getDayInChinese()}`, ganzhi: `${lunar.getDayInGanZhi()}æ—¥`, yi: lunar.getDayYi().join(','), ji: lunar.getDayJi().join(',') };
        const prompt = `ä»Šå¤©æ˜¯ï¼š${todayInfo.date} (å†œå†${todayInfo.lunar}, ${todayInfo.ganzhi})ã€‚å®œï¼š${todayInfo.yi}ã€‚å¿Œï¼š${todayInfo.ji}ã€‚ç”¨æˆ·å‘½ç›˜æ‘˜è¦ï¼š${currentChart.getSummary().substring(0, 500)}... è¯·ç»“åˆä»Šæ—¥çš„æ—¥è¯¾ï¼ˆå¹²æ”¯äº”è¡Œã€å®œå¿Œï¼‰å’Œç”¨æˆ·çš„å‘½ç›˜ç»“æ„ï¼Œç»™å‡ºä¸€å°æ®µï¼ˆ100å­—ä»¥å†…ï¼‰çš„ä»Šæ—¥è¿åŠ¿æé†’ã€‚è¦æ±‚ï¼šç®€å•æ˜“æ‡‚ï¼Œæœ‰å‚è€ƒä»·å€¼ï¼Œå£è¯­åŒ–ï¼Œåƒä¸ªè€æœ‹å‹çš„å®å˜±ã€‚æ³¨æ„ï¼šç›´æ¥è¾“å‡ºè¿åŠ¿å†…å®¹å³å¯ï¼Œä¸¥ç¦åœ¨ç»“å°¾æ˜¾ç¤ºâ€œå…±xxå­—â€æˆ–ç±»ä¼¼çš„å­—æ•°ç»Ÿè®¡ã€‚`;
        const result = await callAI(prompt); aiTextDiv.innerText = result;
    }

    async function analyzeCurrentPalace() {
        if (!selectedPalaceData) return;
        const modal = document.getElementById('ai-modal'); const contentDiv = document.getElementById('ai-result-text');
        modal.style.display = 'flex'; contentDiv.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10">
                <div class="spinner">
                    <div class="spinner1"></div>
                </div>
                <p class="mt-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-400 animate-pulse font-bold tracking-widest">
                    ğŸŒŒ æ˜Ÿè¾°è¿ç»“ä¸­...
                </p>
                <p class="text-xs text-gray-500 mt-2">æ­£åœ¨è§£æã€${selectedPalaceData.name}ã€‘ç£åœº</p>
            </div>
        `;
        const palaceName = selectedPalaceData.name;
        const starsDesc = selectedPalaceData.stars.map(s => { let desc = `${s.name}ï¼ˆäº®åº¦ï¼š${s.brightness}ï¼‰`; if (s.sihua) desc += ` [åŒ–${s.sihua}]`; return desc; }).join('ï¼Œ') || "æ— ä¸»æ˜Ÿ";
        const prompt = `è¯·ä½ æ‰®æ¼”ä¸€ä½ç²¾é€šç´«å¾®æ–—æ•°çš„å‘½ç†å¤§å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·è§£æã€${palaceName}ã€‘çš„è¿åŠ¿ï¼šå®«ä½ï¼š${palaceName} å®«å¹²æ”¯ï¼š${selectedPalaceData.stem}${selectedPalaceData.branch} æ˜Ÿæ›œç»„åˆï¼š${starsDesc} è¦æ±‚ï¼š1. è¯­æ°”ç¥ç§˜ã€ä¸“ä¸šä½†å¯Œæœ‰ç°ä»£æ„Ÿï¼Œå¸¦æœ‰é¼“åŠ±æ€§è´¨ã€‚2. è§£é‡Šä¸»æ˜Ÿçš„æ ¸å¿ƒå«ä¹‰åŠå…¶åœ¨è¯¥å®«ä½çš„è¡¨ç°ã€‚3. å¦‚æœæœ‰å››åŒ–ï¼ˆç¦„æƒç§‘å¿Œï¼‰ï¼Œè¯·è¯´æ˜å…¶å«ä¹‰ã€‚4. å¦‚æœæœ‰å‰æ˜Ÿæˆ–ç…æ˜Ÿï¼Œè¯·è¯´æ˜å…¶å½±å“ã€‚5. å¦‚æœæ— ä¸»æ˜Ÿï¼Œè¯·è§£é‡Šå€Ÿå¯¹å®«æ˜Ÿæ›œçš„å«ä¹‰ï¼ˆä»…ç®€è¿°ï¼‰ã€‚6. è¾“å‡ºæ ¼å¼ä½¿ç”¨ç®€å•çš„ Markdownã€‚`;
        const result = await callAI(prompt); contentDiv.innerHTML = marked.parse(result);
    }

    function closeAiModal() { document.getElementById('ai-modal').style.display = 'none'; }
    function toggleChat() { const win = document.getElementById('chatWindow'); closeAllFloatingWindows(win); win.style.display = win.style.display === 'flex' ? 'none' : 'flex'; }
    function handleChatKey(e) { if (e.key === 'Enter') askMaster(); }
    async function askMaster() {
        if (!currentChart) { alert("è¯·å…ˆç”Ÿæˆæ˜Ÿç›˜ï¼"); return; }
        const input = document.getElementById('userQuery'); const query = input.value.trim(); if (!query) return;
        const chatBox = document.getElementById('chatMessages');
        const userDiv = document.createElement('div'); userDiv.className = 'msg msg-user'; userDiv.innerText = query; chatBox.appendChild(userDiv); chatBox.scrollTop = chatBox.scrollHeight; input.value = '';
        const loadingDiv = document.createElement('div'); loadingDiv.className = 'msg msg-ai animate-pulse'; loadingDiv.innerText = 'å¤§å¸ˆæ­£åœ¨æ¨æ¼”ä¸­...'; chatBox.appendChild(loadingDiv);
        const chartSummary = currentChart.getSummary(); const systemPrompt = `ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ç´«å¾®æ–—æ•°å‘½ç†å¤§å¸ˆã€‚ä»¥ä¸‹æ˜¯ç”¨æˆ·çš„å‘½ç›˜æ•°æ®ï¼š\n${chartSummary}\nè¯·æ ¹æ®æ­¤æ•°æ®å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚è¯­æ°”è¦ä¸“ä¸šã€æ¸©å’Œã€å®¢è§‚ï¼Œé¿å…è¿‡äºå®¿å‘½è®ºï¼Œå¤šç»™å»ºè®¾æ€§å»ºè®®ã€‚`;
        const response = await callAI(query, systemPrompt);
        chatBox.removeChild(loadingDiv);
        const aiDiv = document.createElement('div'); aiDiv.className = 'msg msg-ai'; aiDiv.innerHTML = marked.parse(response); chatBox.appendChild(aiDiv); chatBox.scrollTop = chatBox.scrollHeight;
    }

    function animate() {
        requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera);
        chartObj.rotation.z += 0.0003; if (coreMesh) { coreMesh.rotation.z += 0.005; }
        if (coreUniforms) { coreUniforms.uTime.value = performance.now() / 1000; }
        const dust = scene.getObjectByName('dust'); if (dust) dust.rotation.z -= 0.0002;
    }

    try { init3D(); } catch (e) { console.error("3D Init Failed", e); setTimeout(() => { document.getElementById('loading').style.display = 'none'; }, 1000); }
    
    // First run logic
    setTimeout(() => { const loader = document.getElementById('loading'); if (loader && loader.style.display !== 'none') { loader.style.opacity = 0; setTimeout(() => { loader.style.display = 'none'; }, 500); } }, 2000);
    // Default chart to show something
    generateChart(false); 

</script>
</body>
</html>
